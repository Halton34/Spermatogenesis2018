---
title: "RA blocked cells"
author: "Nils Eling"
date: "11/09/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

This script overlays germ cells isolated after RA blocking with the continuum of germ cells that we discovered. 
RA blocked cells can be downloaded from: https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE107644

# Load data

```{r data}
library(scran)
library(scater)
library(Matrix)
library(ggplot2)

# Data from Chen et al, Cell Research
files <- list.files("../../../../Dropbox (Cambridge University)/SST_spermatocytes/Revisions/Data/Chen_CellResearch/GSE107644_RAW/", full.names = TRUE)

all_cells <- lapply(as.list(files), function(n){
  cur_file <- read.table(n, sep = "\t", header = TRUE)
  rownames(cur_file) <- cur_file[,1]
  cur_file <- cur_file[,-1]
})

all_cells <- do.call("cbind", all_cells)

# Form a sce 
sce_RA <- SingleCellExperiment(assays=list(counts=Matrix::Matrix(as.matrix(all_cells), sparse = TRUE)))
colData(sce_RA)$time_point <- factor(as.character(sapply(colnames(sce_RA), 
                                                         function(n){unlist(strsplit(n, "_"))[1]})),
                                        levels = paste("SpSC", c(0, 2:37), sep = "")) 
colData(sce_RA)$cell_type <- as.character(sapply(colnames(sce_RA), function(n){unlist(strsplit(n, "_"))[2]})) 

# Juvenile and adult data
sce <- readRDS("../../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/10X_data/SCE_all.rds")
sce <- sce[,grepl("B6|P10|P15", colData(sce)$Sample)]
```

## Simple quality checks for Chen et al data

```{r QC}
sce_RA <- calculateQCMetrics(sce_RA)

ggplot(as.data.frame(colData(sce_RA))) + 
  geom_point(aes(total_features_by_counts, log10_total_counts, colour = time_point))

# Remove 2 cells with few features detected
sce_RA <- sce_RA[,colData(sce_RA)$total_features_by_counts > 1250]
```

## Normalization

```{r norm}
clusters <- quickCluster(sce_RA, method = "igraph", irlba.args = c("work" = 100), 
                         max.size = 2000)

sce_RA <- computeSumFactors(sce_RA, clusters=clusters)

sce_RA <- normalize(sce_RA, return_log = TRUE)

# Visaulize as tSNE
set.seed(12345)
sce_RA <- runTSNE(sce_RA)

ggplot(data.frame(tSNE1 = reducedDims(sce_RA)$TSNE[,1],
                  tSNE2 = reducedDims(sce_RA)$TSNE[,2],
                  time_point = colData(sce_RA)$time_point,
                  cell_type = colData(sce_RA)$cell_type)) +
  geom_point(aes(tSNE1, tSNE2, colour = time_point))

ggplot(data.frame(tSNE1 = reducedDims(sce_RA)$TSNE[,1],
                  tSNE2 = reducedDims(sce_RA)$TSNE[,2],
                  time_point = colData(sce_RA)$time_point,
                  cell_type = colData(sce_RA)$cell_type)) +
  geom_point(aes(tSNE1, tSNE2, colour = cell_type))
```

