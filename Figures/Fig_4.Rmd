---
title: "Figure 4"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 2
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, 
        encoding = encoding, output_file = '../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/Figures/Fig_4/Fig_4.html') })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Read in the data

```{r data, message=FALSE}
library(scater)
library(ggplot2)
library(reshape2)
library(plyr)
library(openxlsx)
library(cowplot)
library(viridis)
library(pheatmap)
source("../Functions/auxiliary.R")

# Single cell data
sce <- readRDS("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/10X_data/SCE_emptyDrops.rds")
```

# Marker genes and PCA at P15

```{r}
sce.P15 <- sce[,colData(sce)$Sample == "P15"]
sce.P15 <- normalize(sce.P15)

Lep.Zygot.markers <- marker.detection(sce.P15, 
                                  as.character(colData(sce.P15)$P15Clusters))

write.xlsx(Lep.Zygot.markers, "../../../Dropbox (Cambridge University)/SST_spermatocytes/Revisions/Results/New_figures/Supplemental_tables/Table_S5.xlsx")

# PCA of P15 germ cells
cur_sce <- sce.P15[,grepl("Leptotene|Zygotene|Sperm|Pachytene", colData(sce.P15)$P15Clusters)]
cur_sce <- normalize(cur_sce)

HVgenes <- HVG(cur_sce)

pca  <- prcomp(t(logcounts(cur_sce)[HVgenes,]))

p.clusters <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  clusters = colData(cur_sce)$P15Clusters)) +
  geom_point(aes(PC1, PC2, colour = clusters)) + 
  scale_colour_manual(values = metadata(cur_sce)$colour_vector.P15) +
  guides(colour = FALSE)

p.nogenes <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  no.genes = nexprs(cur_sce, detection_limit = 0))) +
  geom_point(aes(PC1, PC2, colour = no.genes)) + 
  scale_color_gradientn(colours = inferno(100))
```

# Save final figure

```{r save}
A <- plot_grid(emptyDrops, emptyDrops.P15, p.clusters, p.nogenes,
               ncol = 4, nrow = 1, 
               labels = c("A", "B", "C"))
B <- plot_grid(emptyDrops.Sycp1, emptyDrops.H2afx, emptyDrops.Hormad1, emptyDrops.no.genes,
               ncol = 4, nrow = 1, 
               labels = c("D", NULL, NULL))
final <- plot_grid(A, B, C,
                   ncol = 1, nrow = 2)

ggsave("../../../Dropbox (Cambridge University)/SST_spermatocytes/Revisions/Results/New_figures/Supplemental_figures/Fig_S4/Fig_S4.pdf", final,
       width = 20, height = 12)
```

# Save versions of the plots that have figure legends

```{r}
emptyDrops <- ggplot() +
  geom_point(data = df2, aes(tsne1, tsne2, colour = batch), size = 0.5) +
  geom_point(data = df1, aes(tsne1, tsne2, colour = batch), size = 0.5) +
  scale_color_manual(values = metadata(sce)$color_vector)

ggsave("../../../Dropbox (Cambridge University)/SST_spermatocytes/Revisions/Results/New_figures/Supplemental_figures/Fig_S4/emptyDrops_labels.pdf", emptyDrops,
       width = 7, height = 7)

emptyDrops.P15 <- ggplot() +
  geom_point(data = df2[grepl("P15", df2$sample),], 
             aes(tsne1, tsne2, colour = P15), size = 0.5) +
  geom_point(data = df1[grepl("P15", df1$sample),], 
             aes(tsne1, tsne2, colour = P15), size = 0.5) +
  scale_color_manual(values = metadata(sce)$colour_vector.P15) 

ggsave("../../../Dropbox (Cambridge University)/SST_spermatocytes/Revisions/Results/New_figures/Supplemental_figures/Fig_S4/emptyDrops.P15_labels.pdf", emptyDrops.P15,
       width = 7, height = 7)
```