---
title: "Figure 4"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 2
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, 
        encoding = encoding, output_file = '../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/Figures/Fig_4/Fig_4.html') })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Read in the data

```{r data, message=FALSE}
library(scater)
library(ggplot2)
library(reshape2)
library(plyr)
library(openxlsx)
library(cowplot)
library(viridis)
library(pheatmap)
library(irlba)
library(Rtsne)
source("../Functions/auxiliary.R")

# Single cell data
sce <- readRDS("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/10X_data/SCE_emptyDrops.rds")

# Read in RA blocked cells
sce_RA <- readRDS("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/10X_data/SCE_RA.rds")

# Select germ cells from P15
sce <- sce[,colData(sce)$Sample == "P15"]
sce <- sce[,grepl("Pachytene|Differentiating|Zygotene|Leptotene|Undifferentiated", 
                          colData(sce)$P15Clusters) &
                 colData(sce)$AnnotatedClusters != "Outliers" &
             colData(sce)$AnnotatedClusters != "Sertoli"]

# Match the genesnames
sce <- sce[match(intersect(rownames(sce_RA), 
                          rowData(sce)$Symbol), rowData(sce)$Symbol),]
sce_RA <- sce_RA[match(intersect(rownames(sce_RA), rowData(sce)$Symbol), 
                       rownames(sce_RA)),]

rownames(sce_RA) <- rownames(sce)
rowData(sce_RA)$Symbol <- rowData(sce)$Symbol
rowData(sce_RA)$ID <- rowData(sce)$ID
```

# Map RA cells to germ cells of P15 sample

```{r}
# Select Early germ cells from RA blocked cells
sce_early_RA <- sce_RA[,grepl("TypeB|A1|ePL|G1|mPL|eP|mP|lPL|Z|L|ln", colData(sce_RA)$cell_type)]

sce <- normalize(sce)
sce_early_RA <- normalize(sce_early_RA)

# Batch correction
# Calculate highly variable genes
HVG.genes <- lapply(list(sce, sce_early_RA), function(n){
    HVG <- trendVar(n, use.spikes = FALSE)
    decomposeVar(n, HVG)
  })
  
HVG.df <- do.call("combineVar", HVG.genes)
HVG.df <- HVG.df[order(HVG.df$bio, decreasing = TRUE),]
genes <- rownames(HVG.df)[1:1000]
  
# Batch correction
corrected <- mnnCorrect(as.matrix(logcounts(sce)[genes,]),
                        as.matrix(logcounts(sce_early_RA)[genes,]), 
                        cos.norm.in=TRUE, cos.norm.out=TRUE, sigma=0.1)
# Visualization
set.seed(123)
pca <- prcomp_irlba(t(do.call("cbind", corrected$corrected)), n = 50)
tsne <- Rtsne(pca$x, pca = FALSE, perplexity = 50)

# Plot cellRanger and emptyDrops distribution
cur_tsne <- tsne$Y[1:ncol(sce),]
emptyDrops <- ggplot() +
  geom_point(data = data.frame(tSNE1 = cur_tsne[sce$AnnotatedClusters == "NewCell",1],
                  tSNE2 = cur_tsne[sce$AnnotatedClusters == "NewCell",2],
                  clusters = sce$AnnotatedClusters[sce$AnnotatedClusters == "NewCell"]),
             aes(tSNE1, tSNE2, colour = clusters)) +
    geom_point(data = data.frame(tSNE1 = cur_tsne[sce$AnnotatedClusters != "NewCell",1],
                  tSNE2 = cur_tsne[sce$AnnotatedClusters != "NewCell",2],
                  clusters = sce$AnnotatedClusters[sce$AnnotatedClusters != "NewCell"]),
             aes(tSNE1, tSNE2, colour = clusters)) +
            scale_colour_manual(values = metadata(sce)$color_vector)
```

```{r}
cur_sce <- normalize(cur_sce)

HVgenes <- HVG(cur_sce)

pca  <- prcomp(t(logcounts(cur_sce)[HVgenes,]))

p.clusters <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  clusters = colData(cur_sce)$P15Clusters)) +
  geom_point(aes(PC1, PC2, colour = clusters)) + 
  scale_colour_manual(values = metadata(cur_sce)$colour_vector.P15) +
  guides(colour = FALSE)

p.nogenes <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  no.genes = nexprs(cur_sce, detection_limit = 0))) +
  geom_point(aes(PC1, PC2, colour = no.genes)) + 
  scale_color_gradientn(colours = inferno(100))

Lep.Zygot.markers <- marker.detection(sce.P15, 
                                  as.character(colData(sce.P15)$P15Clusters))

write.xlsx(Lep.Zygot.markers, "../../../Dropbox (Cambridge University)/SST_spermatocytes/Revisions/Results/New_figures/Supplemental_tables/Table_S5.xlsx")
```

# Visualize RA blocked cells on empty drops

```{r}
# Select only the germ cells
sce.P15 <- sce[,grepl("Pachytene|Differentiating|Zygotene|Leptotene|Undifferentiated", colData(sce)$P15Clusters) &
                 colData(sce)$AnnotatedClusters != "Outliers"]

# Select Early germ cells from RA blocked cells
sce_early_RA <- sce_RA[,grepl("TypeB|A1|ePL|G1|mPL|eP|mP|lPL|Z|L|ln|Spo11KOL1", colData(sce_RA)$cell_type)]
sce_early_RA <- sce_early_RA[intersect(rownames(sce_early_RA), rownames(sce.P15)),]
sce.P15 <- sce.P15[rownames(sce_early_RA),]

sce.P15 <- normalize(sce.P15)
sce_early_RA <- normalize(sce_early_RA)

# Batch correction
# Calculate highly variable genes
HVG.genes <- lapply(list(sce.P15, sce_early_RA), function(n){
    HVG <- trendVar(n, use.spikes = FALSE)
    decomposeVar(n, HVG)
  })
  
HVG.df <- do.call("combineVar", HVG.genes)
HVG.df <- HVG.df[order(HVG.df$bio, decreasing = TRUE),]
genes <- rownames(HVG.df)[1:1000]
  
# Batch correction
corrected <- mnnCorrect(as.matrix(logcounts(sce.P15)[genes,]),
                        as.matrix(logcounts(sce_early_RA)[genes,]), 
                        cos.norm.in=TRUE, cos.norm.out=TRUE, sigma=0.1)

# Assign mutual nearest neighbours in P15 sample with cell identity from RA blocked cells
new.cellID <- vector(length = ncol(sce.P15))
new.cellID[as.integer(corrected$pairs[[2]]$other.cell)] <- sce_early_RA$cell_type[as.integer(corrected$pairs[[2]]$current.cell)]
new.cellID[new.cellID == "FALSE"] <- "NewCell"
colData(sce.P15)$RA_blocked_identity <- new.cellID

# Visualization
set.seed(111)
pca <- prcomp_irlba(t(do.call("cbind", corrected$corrected)), n = 50)
tsne <- Rtsne(pca$x, pca = FALSE, perplexity = 50)

# CellRanger threshold
empty_drops <- ggplot() +
  geom_point(data = data.frame(tSNE1 = tsne$Y[1:ncol(sce.P15),1],
                  tSNE2 = tsne$Y[1:ncol(sce.P15),2],
                  cluster = colData(sce.P15)$AnnotatedClusters),
             aes(tSNE1, tSNE2, colour = cluster)) + 
  scale_color_manual(values = c(metadata(sce.P15)$color_vector,
                                metadata(sce_early_RA)$colour_vector_RA, "NewCell" = "black"))

# CellRanger threshold with RA mapped cells
empty_drops_RA <- ggplot() +
  geom_point(data = data.frame(tSNE1 = tsne$Y[1:ncol(sce.P15),1],
                  tSNE2 = tsne$Y[1:ncol(sce.P15),2],
                  cluster = colData(sce.P15)$AnnotatedClusters),
             aes(tSNE1, tSNE2, colour = cluster)) + 
    geom_point(data = data.frame(tSNE1 = tsne$Y[(ncol(sce.P15)+1):(ncol(sce.P15)+ncol(sce_early_RA)),1],
                  tSNE2 = tsne$Y[(ncol(sce.P15)+1):(ncol(sce.P15)+ncol(sce_early_RA)),2],
                  cell_type = colData(sce_early_RA)$cell_type),
             aes(tSNE1, tSNE2, colour = cell_type, size = 3)) +
  scale_color_manual(values = c(metadata(sce.P15)$color_vector,
                                metadata(sce_early_RA)$colour_vector_RA, "NewCell" = "black"))

# EmptyDrops threshold
empty_drops_clustered <- ggplot() +
  geom_point(data = data.frame(tSNE1 = tsne$Y[1:ncol(sce.P15),1],
                  tSNE2 = tsne$Y[1:ncol(sce.P15),2],
                  cluster = colData(sce.P15)$P15Clusters),
             aes(tSNE1, tSNE2, colour = cluster)) + 
    geom_point(data = data.frame(tSNE1 = tsne$Y[(ncol(sce.P15)+1):(ncol(sce.P15)+ncol(sce_early_RA)),1],
                  tSNE2 = tsne$Y[(ncol(sce.P15)+1):(ncol(sce.P15)+ncol(sce_early_RA)),2],
                  cell_type = colData(sce_early_RA)$cell_type),
             aes(tSNE1, tSNE2, colour = cell_type, size = 3)) +
  scale_color_manual(values = c(metadata(sce.P15)$colour_vector.P15,
                                metadata(sce_early_RA)$colour_vector_RA, "NewCell" = "black"))
```

# Save final figure

```{r save}
A <- plot_grid(Gfra1 + theme(legend.position=c(.05,.8)), Nanos3+ theme(legend.position=c(.05,.8)), Stra8+ theme(legend.position=c(.05,.8)), Dmrtb1+ theme(legend.position=c(.05,.8)), samples+ theme(legend.position=c(.05,.8)), p.clusters + theme(legend.position=c(.05,.8)), ncol = 6)
B_legend1 <- get_legend(empty_drops + theme(legend.position="bottom"))
B_legend2 <- get_legend(empty_drops_RA + theme(legend.position="bottom"))
B_legend3 <- get_legend(empty_drops_clustered + theme(legend.position = "bottom"))
B <- plot_grid(empty_drops+ theme(legend.position="none"), empty_drops_RA+ theme(legend.position="none"), empty_drops_clustered+ theme(legend.position="none"), B_legend1, B_legend2, B_legend3, ncol = 3, nrow = 2, rel_heights = c(4,1))
final <- plot_grid(A, B, nrow=2, rel_heights = c(1,2))

ggsave("../../../Dropbox (Cambridge University)/SST_spermatocytes/Revisions/Results/New_figures/Fig_3/Fig_3.pdf",
       final, width = 25, height = 20)
```

# Save final figure

```{r save}
A <- plot_grid(emptyDrops, emptyDrops.P15, p.clusters, p.nogenes,
               ncol = 4, nrow = 1, 
               labels = c("A", "B", "C"))
B <- plot_grid(emptyDrops.Sycp1, emptyDrops.H2afx, emptyDrops.Hormad1, emptyDrops.no.genes,
               ncol = 4, nrow = 1, 
               labels = c("D", NULL, NULL))
final <- plot_grid(A, B, C,
                   ncol = 1, nrow = 2)

ggsave("../../../Dropbox (Cambridge University)/SST_spermatocytes/Revisions/Results/New_figures/Supplemental_figures/Fig_S4/Fig_S4.pdf", final,
       width = 20, height = 12)
```

# Save versions of the plots that have figure legends

```{r}
emptyDrops <- ggplot() +
  geom_point(data = df2, aes(tsne1, tsne2, colour = batch), size = 0.5) +
  geom_point(data = df1, aes(tsne1, tsne2, colour = batch), size = 0.5) +
  scale_color_manual(values = metadata(sce)$color_vector)

ggsave("../../../Dropbox (Cambridge University)/SST_spermatocytes/Revisions/Results/New_figures/Supplemental_figures/Fig_S4/emptyDrops_labels.pdf", emptyDrops,
       width = 7, height = 7)

emptyDrops.P15 <- ggplot() +
  geom_point(data = df2[grepl("P15", df2$sample),], 
             aes(tsne1, tsne2, colour = P15), size = 0.5) +
  geom_point(data = df1[grepl("P15", df1$sample),], 
             aes(tsne1, tsne2, colour = P15), size = 0.5) +
  scale_color_manual(values = metadata(sce)$colour_vector.P15) 

ggsave("../../../Dropbox (Cambridge University)/SST_spermatocytes/Revisions/Results/New_figures/Supplemental_figures/Fig_S4/emptyDrops.P15_labels.pdf", emptyDrops.P15,
       width = 7, height = 7)
```