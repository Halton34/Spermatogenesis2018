---
title: "Figure 5"
author: "nils Eling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 2
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, 
        encoding = encoding, output_file = '/Users/nils/Dropbox (Cambridge University)/SST_spermatocytes/Analysis/Figures/Fig_5_v2.html') })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load data and libraries

```{r data, message=FALSE}
library(rtracklayer)
library(EnrichedHeatmap)
library(GenomicFeatures)
library(EnsDb.Mmusculus.v79)
library(TxDb.Mmusculus.UCSC.mm10.ensGene)
library(scater)
library(plyr)
library(reshape2)
library(pheatmap)
library(viridis)
library(plot3D)
library(ggsci)
library(cowplot)
library(openxlsx)
library(csaw)

# Generate feature annotation
tss <- promoters(genes(EnsDb.Mmusculus.v79), 
                 upstream = 0, downstream = 1)
tss <- tss[seqnames(tss) %in% c(as.character(1:19), "X", "Y", "MT"),]
seqlevels(tss) <- c(as.character(1:19), "X", "Y", "MT")
tss.X <- tss[seqnames(tss) == "X"]

prom <- promoters(genes(EnsDb.Mmusculus.v79))
prom <- prom[seqnames(prom) %in% c(as.character(1:19), "X", "Y", "MT"),]
seqlevels(prom) <- c(as.character(1:19), "X", "Y", "MT")
prom.X <- prom[seqnames(prom) == "X"]
prom.Y <- prom[seqnames(prom) == "Y"]
prom.9 <- prom[seqnames(prom) == "9"]

gen <- genes(EnsDb.Mmusculus.v79)
gen <- gen[seqnames(gen) %in% c(as.character(1:19), "X", "Y", "MT"),]
seqlevels(gen) <- c(as.character(1:19), "X", "Y", "MT")
gen.X <- gen[seqnames(gen) == "X"]

# Make TXDB for mus musculus
#mmusculusEnsembl <- makeTxDbFromBiomart(dataset="mmusculus_gene_ensembl")

black <- import("http://mitra.stanford.edu/kundaje/akundaje/release/blacklists/mm10-mouse/mm10.blacklist.bed.gz")

# Read in sce data
#sce <- readRDS("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/10X_data/SCE_all.rds")
#sce <- sce[,grepl("B6", colData(sce)$Sample) & 
#             colData(sce)$AnnotatedClusters %in% #levels(colData(sce)$AnnotatedClusters)[1:23]]
#sce <- normalize(sce)

# Select XChr genes
#genenames <- read.table("../Data/Mouse_genes.txt", sep = "\t", header = TRUE, stringsAsFactors = FALSE)
#sce.XChr <- sce[rowData(sce)$ID %in% 
#                  prom.X$gene_id,]
#sce.XChr <- normalize(sce.XChr)

# Bulk data
bulk <- readRDS("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/bulk/norm/1st_wave_bulk_norm_reverse-stranded.rds")

# Meta info
meta <- as.data.frame(read.xlsx("../../../Dropbox (Cambridge University)/SST_spermatocytes/ArrayExpress/Bulk/sdrf.xlsx"))

# Read in genelists
retro <- read.xlsx("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/Figures/Fig_5/X_retrogenes.xlsx")
retro <- retro[grepl("ENS", retro$Parental.Gene),]

K27writers.Rnf8 <- read.xlsx("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/Figures/Fig_5/Adams_et_al_down_in_RS_after_KO.xlsx", sheet = 1)
K27writers.Scml2 <- read.xlsx("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/Figures/Fig_5/Adams_et_al_down_in_RS_after_KO.xlsx", sheet = 2)
```

# X chromosome

# Visualize the normalized H3K9me3 and H3K4me3 normalized counts in promoter regions

```{r}
# Find spermatid specific genes first
# Select X chromosome genes
bulk.X <- bulk[intersect(prom.X$gene_id, rownames(bulk)),]
bulk.X <- bulk.X[rowMeans(bulk.X) > 10,]

# Collect day info on libraries
df <- data.frame(library = meta$Source.Name,
                 day = meta$`Characteristics.[Age]`)
bulk.X <- bulk.X[,df$library]

# Order genes based on their logFC between spermatocytes (< P20)
# and spermatids (> P20)
bulk.X <- bulk.X[order(log(rowMeans(bulk.X[,df$day < 20])/
                   rowMeans(bulk.X[,df$day > 20])), decreasing = TRUE),]

# Save info if gene is spermatid specifc or not
spermatid.spec <- ifelse(log(rowMeans(bulk.X[,df$day < 20])/
                   rowMeans(bulk.X[,df$day > 20])) < -2, TRUE, FALSE)
```

Collect H3K4 and H3K9 signal for these promoters

```{r}
H3K4me3.normReads <- readRDS("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/CnR/DB/H3K4me3/H3K4me3_1000_normReads.rds")
H3K9me3.normReads <- readRDS("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/CnR/DB/H3K9me3/H3K9me3_1000_normReads.rds")
cur_prom <- prom.X[match(rownames(bulk.X), prom.X$gene_id)]
cur_df <- data.frame(row.names = rownames(bulk.X),
                     genenames = prom.X$gene_name[match(rownames(bulk.X), 
                                                        prom.X$gene_id)],
                     spermatid_specific = spermatid.spec,
                     retro = ifelse(rownames(bulk.X) %in% retro$Parental.Gene, 1, 0),
                     Rnf8 = ifelse(prom.X$gene_name[match(rownames(bulk.X), 
                                                        prom.X$gene_id)] %in% 
                                     K27writers.Rnf8$gene_id, 1, 0),
                     Scml2 = ifelse(prom.X$gene_name[match(rownames(bulk.X), 
                                                        prom.X$gene_id)] %in% 
                                     K27writers.Scml2$gene_id, 1, 0))


# K9 signal
olap.K9 <- findOverlaps(cur_prom, H3K9me3.normReads$windows, minoverlap = 500L)
cur_df$K9.spermatocytes <- rep(NA, nrow(cur_df))
cur_df$K9.spermatocytes[unique(queryHits(olap.K9))] <- ddply(data.frame(olap.K9, 
                enrichment.spermatocytes =
                  rowMeans(H3K9me3.normReads$normReads[subjectHits(olap.K9),
                                    c("spermatocytes_1", "spermatocytes_2")]
                )), .(queryHits), summarize, 
                mean = mean(enrichment.spermatocytes))$mean

cur_df$K9.spermatids <- rep(NA, nrow(cur_df))
cur_df$K9.spermatids[unique(queryHits(olap.K9))] <- ddply(data.frame(olap.K9, 
                enrichment.spermatocytes =
                  rowMeans(H3K9me3.normReads$normReads[subjectHits(olap.K9),
                                    c("spermatids_1", "spermatids_2")]
                )), .(queryHits), summarize, 
                mean = mean(enrichment.spermatocytes))$mean

# K4 signal
olap.K4 <- findOverlaps(cur_prom, H3K4me3.normReads$windows, minoverlap = 500L)
cur_df$K4.spermatocytes <- rep(NA, nrow(cur_df))
cur_df$K4.spermatocytes[unique(queryHits(olap.K4))] <- ddply(data.frame(olap.K4, 
                enrichment.spermatocytes =
                  rowMeans(H3K4me3.normReads$normReads[subjectHits(olap.K4),
                                    c("spermatocytes_1", "spermatocytes_2")]
                )), .(queryHits), summarize, 
                mean = mean(enrichment.spermatocytes))$mean

cur_df$K4.spermatids <- rep(NA, nrow(cur_df))
cur_df$K4.spermatids[unique(queryHits(olap.K4))] <- ddply(data.frame(olap.K4, 
                enrichment.spermatocytes =
                  rowMeans(H3K4me3.normReads$normReads[subjectHits(olap.K4),
                                    c("spermatids_1", "spermatids_2")]
                )), .(queryHits), summarize, 
                mean = mean(enrichment.spermatocytes))$mean

```

Plot heatmaps

```{r, fig.height=30, fig.width=10}
cur_df <- cur_df[!is.na(cur_df$K9.spermatocytes) & !is.na(cur_df$K4.spermatocytes),]
cur_df <- cur_df[order(as.numeric(cur_df$spermatid_specific), cur_df$K9.spermatocytes),]
cur_mat <- bulk.X[rownames(cur_df),]

# Full heatmap
pheatmap(log2(cur_mat + 1), 
         cluster_cols = FALSE, 
         cluster_rows = FALSE, show_rownames = FALSE,
         color = viridis(100),
         border_color = NA,
         labels_col = paste("P", meta$`Characteristics.[Age]`, sep = ""),
         annotation_row = data.frame(row.names = rownames(cur_mat),
        H3K4me3.spermatocytes = cur_df[rownames(cur_mat),"K4.spermatocytes"],
        H3K9me3.spermatocytes = cur_df[rownames(cur_mat),"K9.spermatocytes"],
        retro = cur_df[rownames(cur_mat),"retro"],
        Rnf8 = cur_df[rownames(cur_mat),"Rnf8"],
        Scml2 = cur_df[rownames(cur_mat),"Scml2"]),       
        cellheight = 0.5, cellwidth = 8, fontsize = 7)

# We split genes based on spermatid specificity and high or low K9 in spermatocytes
cur_df <- cur_df[!is.na(cur_df$K9.spermatocytes) & !is.na(cur_df$K4.spermatocytes),]
cur_df <- cur_df[order(as.numeric(cur_df$spermatid_specific), cur_df$K9.spermatocytes),]
cur_mat <- bulk.X[rownames(cur_df),]
cur_mat <- cur_mat[cur_df$spermatid_specific == FALSE & cur_df$K9.spermatocytes < 0.5, ]

# Plot heatmap - non-spermatid specifc - low K9
pheatmap(log2(cur_mat + 1), 
         cluster_cols = FALSE, 
         cluster_rows = FALSE, show_rownames = FALSE,
         color = viridis(100),
         border_color = NA,
         labels_col = paste("P", meta$`Characteristics.[Age]`, sep = ""),
         annotation_row = data.frame(row.names = rownames(cur_mat),
        H3K4me3.spermatocytes = cur_df[rownames(cur_mat),"K4.spermatocytes"],
        H3K9me3.spermatocytes = cur_df[rownames(cur_mat),"K9.spermatocytes"]),       
        cellheight = 1, cellwidth = 8, fontsize = 7)

cur_mat <- bulk.X[rownames(cur_df),]
cur_mat <- cur_mat[cur_df$spermatid_specific == FALSE & cur_df$K9.spermatocytes > 0.5, ]

# Plot heatmap - non-spermatid specifc - high K9
pheatmap(log2(cur_mat + 1), 
         cluster_cols = FALSE, 
         cluster_rows = FALSE, labels_row = prom.X$gene_name[match(rownames(cur_mat), 
                                                                   prom.X$gene_id)],
         color = viridis(100),
         border_color = NA,
         labels_col = paste("P", meta$`Characteristics.[Age]`, sep = ""),
         annotation_row = data.frame(row.names = rownames(cur_mat),
        H3K4me3.spermatocytes = cur_df[rownames(cur_mat),"K4.spermatocytes"],
        H3K9me3.spermatocytes = cur_df[rownames(cur_mat),"K9.spermatocytes"]),       
        cellheight = 8, cellwidth = 8, fontsize = 7)

cur_mat <- bulk.X[rownames(cur_df),]
cur_mat <- cur_mat[cur_df$spermatid_specific == TRUE & cur_df$K9.spermatocytes < 0.5, ]

# Plot heatmap - non-spermatid specifc - low K9
pheatmap(log2(cur_mat + 1), 
         cluster_cols = FALSE, 
         cluster_rows = FALSE, show_rownames = FALSE,
         color = viridis(100),
         border_color = NA,
         labels_col = paste("P", meta$`Characteristics.[Age]`, sep = ""),
         annotation_row = data.frame(row.names = rownames(cur_mat),
        H3K4me3.spermatocytes = cur_df[rownames(cur_mat),"K4.spermatocytes"],
        H3K9me3.spermatocytes = cur_df[rownames(cur_mat),"K9.spermatocytes"]),       
        cellheight = 1, cellwidth = 8, fontsize = 7, 
        annotation_colors = list(H3K9me3.spermatocytes = inferno(100)),
        )

cur_mat <- bulk.X[rownames(cur_df),]
cur_mat <- cur_mat[cur_df$spermatid_specific == TRUE & cur_df$K9.spermatocytes > 0.5, ]

# Plot heatmap - non-spermatid specifc - high K9
pheatmap(log2(cur_mat + 1), 
         cluster_cols = FALSE, 
         cluster_rows = FALSE, labels_row = prom.X$gene_name[match(rownames(cur_mat), 
                                                                   prom.X$gene_id)],
         color = viridis(100),
         border_color = NA,
         labels_col = paste("P", meta$`Characteristics.[Age]`, sep = ""),
         annotation_row = data.frame(row.names = rownames(cur_mat),
        H3K4me3.spermatocytes = cur_df[rownames(cur_mat),"K4.spermatocytes"],
        H3K9me3.spermatocytes = cur_df[rownames(cur_mat),"K9.spermatocytes"]),       
        cellheight = 8, cellwidth = 8, fontsize = 7)


```

# Y chromosome

# Visualize the normalized H3K9me3 and H3K4me3 normalized counts in promoter regions

```{r}
# Find spermatid specific genes first
# Select Y chromosome genes
bulk.Y <- bulk[intersect(prom.Y$gene_id, rownames(bulk)),]
bulk.Y <- bulk.Y[rowMeans(bulk.Y) > 10,]

# Collect day info on libraries
df <- data.frame(library = meta$Source.Name,
                 day = meta$`Characteristics.[Age]`)
bulk.Y <- bulk.Y[,df$library]

# Order genes based on their logFC between spermatocytes (< P20)
# and spermatids (> P20)
bulk.Y <- bulk.Y[order(log(rowMeans(bulk.Y[,df$day < 20])/
                   rowMeans(bulk.Y[,df$day > 20])), decreasing = TRUE),]

# Save info if gene is spermatid specifc or not
spermatid.spec <- ifelse(log(rowMeans(bulk.Y[,df$day < 20])/
                   rowMeans(bulk.Y[,df$day > 20])) < -2, TRUE, FALSE)
```

Collect H3K4 and H3K9 signal for these promoters

```{r}
cur_prom <- prom.Y[match(rownames(bulk.Y), prom.Y$gene_id)]
cur_df <- data.frame(row.names = rownames(bulk.Y),
                     genenames = prom.Y$gene_name[match(rownames(bulk.Y), 
                                                        prom.Y$gene_id)],
                     spermatid_specific = spermatid.spec)


# K9 signal
olap.K9 <- findOverlaps(cur_prom, H3K9me3.normReads$windows, minoverlap = 500L)
cur_df$K9.spermatocytes <- rep(NA, nrow(cur_df))
cur_df$K9.spermatocytes[unique(queryHits(olap.K9))] <- ddply(data.frame(olap.K9, 
                enrichment.spermatocytes =
                  rowMeans(H3K9me3.normReads$normReads[subjectHits(olap.K9),
                                    c("spermatocytes_1", "spermatocytes_2")]
                )), .(queryHits), summarize, 
                mean = mean(enrichment.spermatocytes))$mean

cur_df$K9.spermatids <- rep(NA, nrow(cur_df))
cur_df$K9.spermatids[unique(queryHits(olap.K9))] <- ddply(data.frame(olap.K9, 
                enrichment.spermatocytes =
                  rowMeans(H3K9me3.normReads$normReads[subjectHits(olap.K9),
                                    c("spermatids_1", "spermatids_2")]
                )), .(queryHits), summarize, 
                mean = mean(enrichment.spermatocytes))$mean

# K4 signal
olap.K4 <- findOverlaps(cur_prom, H3K4me3.normReads$windows, minoverlap = 500L)
cur_df$K4.spermatocytes <- rep(NA, nrow(cur_df))
cur_df$K4.spermatocytes[unique(queryHits(olap.K4))] <- ddply(data.frame(olap.K4, 
                enrichment.spermatocytes =
                  rowMeans(H3K4me3.normReads$normReads[subjectHits(olap.K4),
                                    c("spermatocytes_1", "spermatocytes_2")]
                )), .(queryHits), summarize, 
                mean = mean(enrichment.spermatocytes))$mean

cur_df$K4.spermatids <- rep(NA, nrow(cur_df))
cur_df$K4.spermatids[unique(queryHits(olap.K4))] <- ddply(data.frame(olap.K4, 
                enrichment.spermatocytes =
                  rowMeans(H3K4me3.normReads$normReads[subjectHits(olap.K4),
                                    c("spermatids_1", "spermatids_2")]
                )), .(queryHits), summarize, 
                mean = mean(enrichment.spermatocytes))$mean

```

Plot heatmaps

```{r, fig.height=30, fig.width=10}
# We split genes based on spermatid specificity and high or low K9 in spermatocytes
cur_df <- cur_df[!is.na(cur_df$K9.spermatocytes) & !is.na(cur_df$K4.spermatocytes),]
cur_df <- cur_df[order(as.numeric(cur_df$spermatid_specific), cur_df$K9.spermatocytes),]
cur_mat <- bulk.Y[rownames(cur_df),]
cur_mat <- cur_mat[cur_df$spermatid_specific == FALSE & cur_df$K9.spermatocytes < 0.5, ]

# Plot heatmap - non-spermatid specifc - low K9
pheatmap(log2(cur_mat + 1), 
         cluster_cols = FALSE, 
         cluster_rows = FALSE, show_rownames = FALSE,
         color = viridis(100),
         border_color = NA,
         labels_col = paste("P", meta$`Characteristics.[Age]`, sep = ""),
         annotation_row = data.frame(row.names = rownames(cur_mat),
        H3K4me3.spermatocytes = cur_df[rownames(cur_mat),"K4.spermatocytes"],
        H3K9me3.spermatocytes = cur_df[rownames(cur_mat),"K9.spermatocytes"]),       
        cellheight = 4, cellwidth = 8, fontsize = 7)

cur_mat <- bulk.Y[rownames(cur_df),]
cur_mat <- cur_mat[cur_df$spermatid_specific == FALSE & cur_df$K9.spermatocytes > 0.5, ]

# Plot heatmap - non-spermatid specifc - high K9
pheatmap(log2(cur_mat + 1), 
         cluster_cols = FALSE, 
         cluster_rows = FALSE, labels_row = prom.Y$gene_name[match(rownames(cur_mat), 
                                                                   prom.Y$gene_id)],
         color = viridis(100),
         border_color = NA,
         labels_col = paste("P", meta$`Characteristics.[Age]`, sep = ""),
         annotation_row = data.frame(row.names = rownames(cur_mat),
        H3K4me3.spermatocytes = cur_df[rownames(cur_mat),"K4.spermatocytes"],
        H3K9me3.spermatocytes = cur_df[rownames(cur_mat),"K9.spermatocytes"]),       
        cellheight = 8, cellwidth = 8, fontsize = 7)

cur_mat <- bulk.Y[rownames(cur_df),]
cur_mat <- cur_mat[cur_df$spermatid_specific == TRUE & cur_df$K9.spermatocytes < 0.5, ]

# Plot heatmap - non-spermatid specifc - low K9
pheatmap(log2(as.matrix(cur_mat) + 1), 
         cluster_cols = FALSE, 
         cluster_rows = FALSE, show_rownames = FALSE,
         color = viridis(100),
         border_color = NA,
         labels_col = paste("P", meta$`Characteristics.[Age]`, sep = ""),
         annotation_row = data.frame(row.names = rownames(cur_mat),
        H3K4me3.spermatocytes = cur_df[rownames(cur_mat),"K4.spermatocytes"],
        H3K9me3.spermatocytes = cur_df[rownames(cur_mat),"K9.spermatocytes"]),       
        cellheight = 4, cellwidth = 8, fontsize = 7, 
        annotation_colors = list(H3K9me3.spermatocytes = inferno(100)),
        )

cur_mat <- bulk.Y[rownames(cur_df),]
cur_mat <- cur_mat[cur_df$spermatid_specific == TRUE & cur_df$K9.spermatocytes > 0.5, ]

# Plot heatmap - non-spermatid specifc - high K9
pheatmap(log2(cur_mat + 1), 
         cluster_cols = FALSE, 
         cluster_rows = FALSE, labels_row = prom.Y$gene_name[match(rownames(cur_mat), 
                                                                   prom.Y$gene_id)],
         color = viridis(100),
         border_color = NA,
         labels_col = paste("P", meta$`Characteristics.[Age]`, sep = ""),
         annotation_row = data.frame(row.names = rownames(cur_mat),
        H3K4me3.spermatocytes = cur_df[rownames(cur_mat),"K4.spermatocytes"],
        H3K9me3.spermatocytes = cur_df[rownames(cur_mat),"K9.spermatocytes"]),       
        cellheight = 8, cellwidth = 8, fontsize = 7)


```

# Visualize K3 and K9 signal for spermtid specifc an non-specifc genes

```{r}
# Collect mean K4 and K9 signal from spermtid specifc and non-specific genes  
ddply(cur_df, .(spermatid_specific), summarize, mean.K9.spermatocytes = mean(K9.spermatocytes, na.rm = TRUE),
      mean.K9.spermatids = mean(K9.spermatids, na.rm = TRUE),
      mean.K4.spermatocytes = mean(K4.spermatocytes, na.rm = TRUE),
      mean.K4.spermatids = mean(K4.spermatids, na.rm = TRUE))

# Fisher test
# Set up contigency table - K9 high > 0.5
K9.spermatocytes.table <- matrix(data = NA, ncol = 2, nrow = 2)
colnames(K9.spermatocytes.table) <- c("specific", "non-specific")
rownames(K9.spermatocytes.table) <- c("K9-high", "K9-low")
K9.spermatocytes.table[1,1] <- sum(cur_df$K9.spermatocytes > 0.5 & !is.na(cur_df$K9.spermatocytes) & cur_df$spermatid_specific == TRUE) 
K9.spermatocytes.table[1,2] <- sum(cur_df$K9.spermatocytes > 0.5 & !is.na(cur_df$K9.spermatocytes) & cur_df$spermatid_specific == FALSE) 
K9.spermatocytes.table[2,1] <- sum(cur_df$K9.spermatocytes < 0.5 & !is.na(cur_df$K9.spermatocytes) & cur_df$spermatid_specific == TRUE) 
K9.spermatocytes.table[2,2] <- sum(cur_df$K9.spermatocytes < 0.5 & !is.na(cur_df$K9.spermatocytes) & cur_df$spermatid_specific == FALSE)

fisher.test(K9.spermatocytes.table, alternative = "greater")
```



# 9 chromosome

# Visualize the normalized H3K9me3 and H3K4me3 normalized counts in promoter regions

```{r}
# Find spermatid specific genes first
# Select 9 chromosome genes
bulk.9 <- bulk[intersect(prom.9$gene_id, rownames(bulk)),]
bulk.9 <- bulk.9[rowMeans(bulk.9) > 10,]

# Collect day info on libraries
df <- data.frame(library = meta$Source.Name,
                 day = meta$`Characteristics.[Age]`)
bulk.9 <- bulk.9[,df$library]

# Order genes based on their logFC between spermatocytes (< P20)
# and spermatids (> P20)
bulk.9 <- bulk.9[order(log(rowMeans(bulk.9[,df$day < 20])/
                   rowMeans(bulk.9[,df$day > 20])), decreasing = TRUE),]

# Save info if gene is spermatid specifc or not
spermatid.spec <- ifelse(log(rowMeans(bulk.9[,df$day < 20])/
                   rowMeans(bulk.9[,df$day > 20])) < -2, TRUE, FALSE)
```

Collect H3K4 and H3K9 signal for these promoters

```{r}
cur_prom <- prom.9[match(rownames(bulk.9), prom.9$gene_id)]
cur_df <- data.frame(row.names = rownames(bulk.9),
                     genenames = prom.9$gene_name[match(rownames(bulk.9), 
                                                        prom.9$gene_id)],
                     spermatid_specific = spermatid.spec)


# K9 signal
olap.K9 <- findOverlaps(cur_prom, H3K9me3.normReads$windows, minoverlap = 500L)
cur_df$K9.spermatocytes <- rep(NA, nrow(cur_df))
cur_df$K9.spermatocytes[unique(queryHits(olap.K9))] <- ddply(data.frame(olap.K9, 
                enrichment.spermatocytes =
                  rowMeans(H3K9me3.normReads$normReads[subjectHits(olap.K9),
                                    c("spermatocytes_1", "spermatocytes_2")]
                )), .(queryHits), summarize, 
                mean = mean(enrichment.spermatocytes))$mean

cur_df$K9.spermatids <- rep(NA, nrow(cur_df))
cur_df$K9.spermatids[unique(queryHits(olap.K9))] <- ddply(data.frame(olap.K9, 
                enrichment.spermatocytes =
                  rowMeans(H3K9me3.normReads$normReads[subjectHits(olap.K9),
                                    c("spermatids_1", "spermatids_2")]
                )), .(queryHits), summarize, 
                mean = mean(enrichment.spermatocytes))$mean

# K4 signal
olap.K4 <- findOverlaps(cur_prom, H3K4me3.normReads$windows, minoverlap = 500L)
cur_df$K4.spermatocytes <- rep(NA, nrow(cur_df))
cur_df$K4.spermatocytes[unique(queryHits(olap.K4))] <- ddply(data.frame(olap.K4, 
                enrichment.spermatocytes =
                  rowMeans(H3K4me3.normReads$normReads[subjectHits(olap.K4),
                                    c("spermatocytes_1", "spermatocytes_2")]
                )), .(queryHits), summarize, 
                mean = mean(enrichment.spermatocytes))$mean

cur_df$K4.spermatids <- rep(NA, nrow(cur_df))
cur_df$K4.spermatids[unique(queryHits(olap.K4))] <- ddply(data.frame(olap.K4, 
                enrichment.spermatocytes =
                  rowMeans(H3K4me3.normReads$normReads[subjectHits(olap.K4),
                                    c("spermatids_1", "spermatids_2")]
                )), .(queryHits), summarize, 
                mean = mean(enrichment.spermatocytes))$mean

```

Plot heatmaps

```{r, fig.height=30, fig.width=10}
# We split genes based on spermatid specificity and high or low K9 in spermatocytes
cur_df <- cur_df[!is.na(cur_df$K9.spermatocytes) & !is.na(cur_df$K4.spermatocytes),]
cur_df <- cur_df[order(as.numeric(cur_df$spermatid_specific), cur_df$K9.spermatocytes),]
cur_mat <- bulk.9[rownames(cur_df),]
cur_mat <- cur_mat[cur_df$spermatid_specific == FALSE & cur_df$K9.spermatocytes < 0.5, ]

# Plot heatmap - non-spermatid specifc - low K9
pheatmap(log2(cur_mat + 1), 
         cluster_cols = FALSE, 
         cluster_rows = FALSE, show_rownames = FALSE,
         color = viridis(100),
         border_color = NA,
         labels_col = paste("P", meta$`Characteristics.[Age]`, sep = ""),
         annotation_row = data.frame(row.names = rownames(cur_mat),
        H3K4me3.spermatocytes = cur_df[rownames(cur_mat),"K4.spermatocytes"],
        H3K9me3.spermatocytes = cur_df[rownames(cur_mat),"K9.spermatocytes"]),       
        cellheight = 4, cellwidth = 8, fontsize = 7)

cur_mat <- bulk.9[rownames(cur_df),]
cur_mat <- cur_mat[cur_df$spermatid_specific == FALSE & cur_df$K9.spermatocytes > 0.5, ]

# Plot heatmap - non-spermatid specifc - high K9
pheatmap(log2(cur_mat + 1), 
         cluster_cols = FALSE, 
         cluster_rows = FALSE, labels_row = prom.9$gene_name[match(rownames(cur_mat), 
                                                                   prom.9$gene_id)],
         color = viridis(100),
         border_color = NA,
         labels_col = paste("P", meta$`Characteristics.[Age]`, sep = ""),
         annotation_row = data.frame(row.names = rownames(cur_mat),
        H3K4me3.spermatocytes = cur_df[rownames(cur_mat),"K4.spermatocytes"],
        H3K9me3.spermatocytes = cur_df[rownames(cur_mat),"K9.spermatocytes"]),       
        cellheight = 8, cellwidth = 8, fontsize = 7)

cur_mat <- bulk.9[rownames(cur_df),]
cur_mat <- cur_mat[cur_df$spermatid_specific == TRUE & cur_df$K9.spermatocytes < 0.5, ]

# Plot heatmap - non-spermatid specifc - low K9
pheatmap(log2(as.matrix(cur_mat) + 1), 
         cluster_cols = FALSE, 
         cluster_rows = FALSE, show_rownames = FALSE,
         color = viridis(100),
         border_color = NA,
         labels_col = paste("P", meta$`Characteristics.[Age]`, sep = ""),
         annotation_row = data.frame(row.names = rownames(cur_mat),
        H3K4me3.spermatocytes = cur_df[rownames(cur_mat),"K4.spermatocytes"],
        H3K9me3.spermatocytes = cur_df[rownames(cur_mat),"K9.spermatocytes"]),       
        cellheight = 4, cellwidth = 8, fontsize = 7, 
        annotation_colors = list(H3K9me3.spermatocytes = inferno(100)),
        )

cur_mat <- bulk.9[rownames(cur_df),]
cur_mat <- cur_mat[cur_df$spermatid_specific == TRUE & cur_df$K9.spermatocytes > 0.5, ]

# Plot heatmap - non-spermatid specifc - high K9
pheatmap(log2(cur_mat + 1), 
         cluster_cols = FALSE, 
         cluster_rows = FALSE, labels_row = prom.9$gene_name[match(rownames(cur_mat), 
                                                                   prom.9$gene_id)],
         color = viridis(100),
         border_color = NA,
         labels_col = paste("P", meta$`Characteristics.[Age]`, sep = ""),
         annotation_row = data.frame(row.names = rownames(cur_mat),
        H3K4me3.spermatocytes = cur_df[rownames(cur_mat),"K4.spermatocytes"],
        H3K9me3.spermatocytes = cur_df[rownames(cur_mat),"K9.spermatocytes"]),       
        cellheight = 8, cellwidth = 8, fontsize = 7)


```

# Visualize K3 and K9 signal for spermtid specifc an non-specifc genes

```{r}
# Collect mean K4 and K9 signal from spermtid specifc and non-specific genes  
ddply(cur_df, .(spermatid_specific), summarize, mean.K9.spermatocytes = mean(K9.spermatocytes, na.rm = TRUE),
      mean.K9.spermatids = mean(K9.spermatids, na.rm = TRUE),
      mean.K4.spermatocytes = mean(K4.spermatocytes, na.rm = TRUE),
      mean.K4.spermatids = mean(K4.spermatids, na.rm = TRUE))

# Fisher test
# Set up contigency table - K9 high > 0.5
K9.spermatocytes.table <- matrix(data = NA, ncol = 2, nrow = 2)
colnames(K9.spermatocytes.table) <- c("specific", "non-specific")
rownames(K9.spermatocytes.table) <- c("K9-high", "K9-low")
K9.spermatocytes.table[1,1] <- sum(cur_df$K9.spermatocytes > 0.5 & !is.na(cur_df$K9.spermatocytes) & cur_df$spermatid_specific == TRUE) 
K9.spermatocytes.table[1,2] <- sum(cur_df$K9.spermatocytes > 0.5 & !is.na(cur_df$K9.spermatocytes) & cur_df$spermatid_specific == FALSE) 
K9.spermatocytes.table[2,1] <- sum(cur_df$K9.spermatocytes < 0.5 & !is.na(cur_df$K9.spermatocytes) & cur_df$spermatid_specific == TRUE) 
K9.spermatocytes.table[2,2] <- sum(cur_df$K9.spermatocytes < 0.5 & !is.na(cur_df$K9.spermatocytes) & cur_df$spermatid_specific == FALSE)

fisher.test(K9.spermatocytes.table, alternative = "greater")
```
