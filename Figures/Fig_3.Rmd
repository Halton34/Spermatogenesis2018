---
title: "Figure 3"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 2
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, 
        encoding = encoding, output_file = '/Users/nils/Dropbox (Cambridge University)/SST_spermatocytes/Analysis/Figures/Fig_S3/Fig_3.html') })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Read in the data

```{r data, message=FALSE}
library(scater)
library(ggplot2)
library(reshape2)
library(plyr)
library(openxlsx)
library(cowplot)
library(viridis)
library(pheatmap)
library(Rtsne)
library(irlba)
library(RColorBrewer)
source("../Functions/auxiliary.R")

# Single cell data
sce <- readRDS("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/10X_data/SCE_all.rds")

# Read in markers for spermatogonia
sperm.markers <- read.xlsx("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/Figures/Fig_3/Spermatogonia_Top15.xlsx")
```

# Visualize spermatogonia from P5, P10 and P15

## Peform batch correction on spermatogonia of P5, P10 and P15

```{r}
# To avoid batch effects between the samples, we assume that there are 
# shared cell types between the samples
sce.spermatogonia <- sce[,grepl("P5|P10|P15", colData(sce)$Sample) &
                                       colData(sce)$AnnotatedClusters == "Spermatogonia"]
sce.spermatogonia <- normalize(sce.spermatogonia)
rm(sce)

# Visualize non-batch corrected data
sce.spermatogonia <- runPCA(sce.spermatogonia)
ggplot(data.frame(PC1 = reducedDims(sce.spermatogonia)$PCA[,1],
                  PC2 = reducedDims(sce.spermatogonia)$PCA[,2],
                  samples = colData(sce.spermatogonia)$Sample)) +
  geom_point(aes(PC1, PC2, colour = samples)) + 
  scale_color_manual(values = c("#1f78b4", "#33a02c", "#e31a1c"))

ggplot(data.frame(PC1 = reducedDims(sce.spermatogonia)$PCA[,1],
                  PC2 = reducedDims(sce.spermatogonia)$PCA[,2],
                  Nanos3 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Stra8",])) +
  geom_point(aes(PC1, PC2, colour = Nanos3)) + scale_colour_viridis()

sce.single <- split.sce(sce = sce.spermatogonia, 
                        groups = unique(colData(sce.spermatogonia)$Library), 
                        colData.name = "Library")

# Use P10 as first sample
corrected <- batch.correction(sce.single[c("do17821", "do18195", "do26386", "do26387")])

sce.spermatogonia <- do.call(cbind, sce.single[c("do17821", "do18195", "do26386", "do26387")])
```

```{r, spermatogonia_P5_p10_p15}
# Compute pca 
set.seed(456)
pca <- prcomp(t(corrected))
tsne <- Rtsne(t(corrected))

# Visualize PCA with marker genes
samples <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  samples = colData(sce.spermatogonia)$Sample)) +
  geom_point(aes(PC1, PC2, colour = samples)) + 
  scale_color_manual(values = c("#1f78b4", "#33a02c", "#e31a1c")) 

samples.tsne <- ggplot(data.frame(tsne1 = tsne$Y[,1],
                  tsne2 = tsne$Y[,2],
                  samples = colData(sce.spermatogonia)$Sample)) +
  geom_point(aes(tsne1, tsne2, colour = samples)) + 
  scale_color_manual(values = c("#1f78b4", "#33a02c", "#e31a1c")) 

gene.tsne <- ggplot(data.frame(tsne1 = tsne$Y[,1],
                  tsne2 = tsne$Y[,2],
                  gene = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Ccnd1",])) +
  geom_point(aes(tsne1, tsne2, colour = gene)) + scale_colour_viridis()

# For visualization the non-batch corrected counts are used

#Gfra1 marker for undifferentiated spermatogonia with stem-like function
Gfra1 <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  Gfra1 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Gfra1",])) +
  geom_point(aes(PC1, PC2, colour = Gfra1)) + scale_colour_viridis()

#Nanos3 marker for undifferentiated spermatogonia with progenitor function
Nanos3 <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  Nanos3 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Nanos3",])) +
  geom_point(aes(PC1, PC2, colour = Nanos3)) + scale_colour_viridis()

# Induced by RA and upregulated during spermatogonial differentiation and again later on in preleptotene spermatocytes
Stra8 <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  Stra8 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Stra8",])) +
  geom_point(aes(PC1, PC2, colour = Stra8)) + scale_colour_viridis()

# Ccnd2 for spermatogonial differentiation and Ccnd1 in proliferating spermatogonia
Ccnd2 <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  Ccnd2 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Ccnd2",])) +
  geom_point(aes(PC1, PC2, colour = Ccnd2)) + scale_colour_viridis()

Ccnd1 <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  Ccnd1 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Ccnd1",])) +
  geom_point(aes(PC1, PC2, colour = Ccnd1)) + scale_colour_viridis()

# Rhox13 higher in differentiating spermatogonia
Rhox13 <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  Rhox13 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Rhox13",])) +
  geom_point(aes(PC1, PC2, colour = Rhox13)) + scale_colour_viridis()


#Dmrtb1 mediates mitosis-to-meiosis 
Dmrtb1 <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  Dmrtb1 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Dmrtb1",])) +
  geom_point(aes(PC1, PC2, colour = Dmrtb1)) + scale_colour_viridis()

#Prss50 early meiotic marker
Prss50 <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  Prss50 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Prss50",])) +
  geom_point(aes(PC1, PC2, colour = Prss50)) + scale_colour_viridis()

```

# Clustering of spermatogonia for P5, P10 and P15

```{r}
# Use the same graph based clustering technique
set.seed(123)
g <- buildSNNGraph(corrected, k = 11, pc.approx = TRUE)
clusters <- igraph::cluster_louvain(g)$membership

# Change cluster labels
clusters[clusters == 1] <- "Diff_In_B"
clusters[clusters == 2] <- "Diff_A1_2"
clusters[clusters == 3] <- "pL"
clusters[clusters == 4] <- "Undiff_progenitor"
clusters[clusters == 5] <- "Undiff_transitional"
clusters[clusters == 6] <- "Undiff_stem"
clusters[clusters == 7] <- "Diff_A3_4"
clusters[clusters == 8] <- "Gonocytes"


col_vector <- c("Gonocytes" = "#7A9606",
                "Undiff_stem" = "#0D3D21",
                "Undiff_transitional" = "#87998E",
                "Undiff_progenitor" = "#076E38",
                "Diff_A1_2" = "#5FA37D",
                "Diff_A3_4" = "#87D6B2",
                "Diff_In_B"="#B9EAD6",
                "pL"="#E5DFEA")

p.clusters <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  clusters = as.factor(clusters))) +
  geom_point(aes(PC1, PC2, colour = clusters))+ scale_colour_manual(values = col_vector)

ggplot(data.frame(tsne1 = tsne$Y[,1],
                  tsne2 = tsne$Y[,2],
                  clusters = as.factor(clusters))) +
  geom_point(aes(tsne1, tsne2, colour = clusters))+ scale_colour_manual(values = col_vector)


```

# Find marker genes for these groups

```{r}
spermatogonia.markers <- marker.detection(sce.spermatogonia, 
                                          clusters)

spermatogonia.markers.P5 <- marker.detection(sce.spermatogonia[,sce.spermatogonia$Sample == "P5"], 
                                          clusters[sce.spermatogonia$Sample == "P5"])

write.xlsx(spermatogonia.markers, "../../../Dropbox (Cambridge University)/SST_spermatocytes/Revisions/Results/New_figures/Supplemental_tables/Table_S4.xlsx")
write.xlsx(spermatogonia.markers.P5, "../../../Dropbox (Cambridge University)/SST_spermatocytes/Revisions/Results/New_figures/Supplemental_tables/Table_S4_P5.xlsx")
```

# Visualize RA blocked cells on spermatogonia

```{r RA-spermatogonia}
# Read in RA blocked cell data from Chen et al, Cell Research
sce_RA <- readRDS("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/10X_data/SCE_RA.rds")

# Batch correction
sce.spermatogonia <- sce.spermatogonia[match(intersect(rownames(sce_RA), 
                          rowData(sce.spermatogonia)$Symbol), rowData(sce.spermatogonia)$Symbol),]
sce_RA <- sce_RA[match(intersect(rownames(sce_RA), rowData(sce.spermatogonia)$Symbol), 
                       rownames(sce_RA)),]

rownames(sce_RA) <- rownames(sce.spermatogonia)
rowData(sce_RA)$Symbol <- rowData(sce.spermatogonia)$Symbol
rowData(sce_RA)$ID <- rowData(sce.spermatogonia)$ID

# Select specific cell types 
sce_early_RA <- sce_RA[,grepl("A1|ln|TypeBS|G1|TypeBG2M|ePL", colData(sce_RA)$cell_type)]
sce_early_RA <- normalize(sce_early_RA)

sce.single <- split.sce(sce = sce.spermatogonia, groups = unique(colData(sce.spermatogonia)$Library), 
                        colData.name = "Library")
sce.single$RA <- sce_early_RA

corrected <- batch.correction(sce.single)

# Visualize PCA 
pca <- prcomp(t(corrected))
tsne <- Rtsne(t(corrected))

ggplot() +
  geom_point(data = data.frame(PC1 = pca$x[1:ncol(sce.spermatogonia),1],
                  PC2 = pca$x[1:ncol(sce.spermatogonia),2],
                  cluster = clusters),
             aes(PC1, PC2, colour = cluster)) + 
  geom_point(data = data.frame(PC1 = pca$x[(ncol(sce.spermatogonia)+1):(ncol(sce.spermatogonia)+ncol(sce_early_RA)),1],
                  PC2 = pca$x[(ncol(sce.spermatogonia)+1):(ncol(sce.spermatogonia)+ncol(sce_early_RA)),2],
                  cell_type = colData(sce_early_RA)$cell_type),
             aes(PC1, PC2, colour = cell_type, size = 3)) +
  scale_color_manual(values = c(col_vector,
                                metadata(sce_early_RA)$colour_vector_RA))

ggplot() +
  geom_point(data = data.frame(tsne1 = tsne$Y[1:ncol(sce.spermatogonia),1],
                  tsne2 = tsne$Y[1:ncol(sce.spermatogonia),2],
                  cluster = clusters),
             aes(tsne1, tsne2, colour = cluster)) + 
  geom_point(data = data.frame(tsne1 = tsne$Y[(ncol(sce.spermatogonia)+1):(ncol(sce.spermatogonia)+ncol(sce_early_RA)),1],
                  tsne2 = tsne$Y[(ncol(sce.spermatogonia)+1):(ncol(sce.spermatogonia)+ncol(sce_early_RA)),2],
                  cell_type = colData(sce_early_RA)$cell_type),
             aes(tsne1, tsne2, colour = cell_type, size = 3)) +
  scale_color_manual(values = c(col_vector,
                                metadata(sce_early_RA)$colour_vector_RA))
```

# Visualize RA blocked cells on empty drops

```{r}
# P15 data
sce <- readRDS("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/10X_data/SCE_emptyDrops.rds")
sce <- sce[,grepl("P15", colData(sce)$Sample)]

# Select only the germ cells
sce.P15 <- sce[,grepl("Pachytene|Differentiating|Zygotene|Leptotene|Undifferentiated", colData(sce)$P15Clusters) &
                 colData(sce)$AnnotatedClusters != "Outliers"]

# Select Early germ cells from RA blocked cells
sce_early_RA <- sce_RA[,grepl("TypeB|A1|ePL|G1|mPL|eP|mP|lPL|Z|L|ln|Spo11KOL1", colData(sce_RA)$cell_type)]
sce_early_RA <- sce_early_RA[intersect(rownames(sce_early_RA), rownames(sce.P15)),]
sce.P15 <- sce.P15[rownames(sce_early_RA),]

sce.P15 <- normalize(sce.P15)
sce_early_RA <- normalize(sce_early_RA)

# Batch correction
# Calculate highly variable genes
HVG.genes <- lapply(list(sce.P15, sce_early_RA), function(n){
    HVG <- trendVar(n, use.spikes = FALSE)
    decomposeVar(n, HVG)
  })
  
HVG.df <- do.call("combineVar", HVG.genes)
HVG.df <- HVG.df[order(HVG.df$bio, decreasing = TRUE),]
genes <- rownames(HVG.df)[1:1000]
  
# Batch correction
corrected <- mnnCorrect(as.matrix(logcounts(sce.P15)[genes,]),
                        as.matrix(logcounts(sce_early_RA)[genes,]), 
                        cos.norm.in=TRUE, cos.norm.out=TRUE, sigma=0.1)

# Assign mutual nearest neighbours in P15 sample with cell identity from RA blocked cells
new.cellID <- vector(length = ncol(sce.P15))
new.cellID[as.integer(corrected$pairs[[2]]$other.cell)] <- sce_early_RA$cell_type[as.integer(corrected$pairs[[2]]$current.cell)]
new.cellID[new.cellID == "FALSE"] <- "NewCell"
colData(sce.P15)$RA_blocked_identity <- new.cellID

# Visualization
set.seed(111)
pca <- prcomp_irlba(t(do.call("cbind", corrected$corrected)), n = 50)
tsne <- Rtsne(pca$x, pca = FALSE, perplexity = 50)

# CellRanger threshold
empty_drops <- ggplot() +
  geom_point(data = data.frame(tSNE1 = tsne$Y[1:ncol(sce.P15),1],
                  tSNE2 = tsne$Y[1:ncol(sce.P15),2],
                  cluster = colData(sce.P15)$AnnotatedClusters),
             aes(tSNE1, tSNE2, colour = cluster)) + 
  scale_color_manual(values = c(metadata(sce.P15)$color_vector,
                                metadata(sce_early_RA)$colour_vector_RA, "NewCell" = "black"))

# CellRanger threshold with RA mapped cells
empty_drops_RA <- ggplot() +
  geom_point(data = data.frame(tSNE1 = tsne$Y[1:ncol(sce.P15),1],
                  tSNE2 = tsne$Y[1:ncol(sce.P15),2],
                  cluster = colData(sce.P15)$AnnotatedClusters),
             aes(tSNE1, tSNE2, colour = cluster)) + 
    geom_point(data = data.frame(tSNE1 = tsne$Y[(ncol(sce.P15)+1):(ncol(sce.P15)+ncol(sce_early_RA)),1],
                  tSNE2 = tsne$Y[(ncol(sce.P15)+1):(ncol(sce.P15)+ncol(sce_early_RA)),2],
                  cell_type = colData(sce_early_RA)$cell_type),
             aes(tSNE1, tSNE2, colour = cell_type, size = 3)) +
  scale_color_manual(values = c(metadata(sce.P15)$color_vector,
                                metadata(sce_early_RA)$colour_vector_RA, "NewCell" = "black"))

# EmptyDrops threshold
empty_drops_clustered <- ggplot() +
  geom_point(data = data.frame(tSNE1 = tsne$Y[1:ncol(sce.P15),1],
                  tSNE2 = tsne$Y[1:ncol(sce.P15),2],
                  cluster = colData(sce.P15)$P15Clusters),
             aes(tSNE1, tSNE2, colour = cluster)) + 
    geom_point(data = data.frame(tSNE1 = tsne$Y[(ncol(sce.P15)+1):(ncol(sce.P15)+ncol(sce_early_RA)),1],
                  tSNE2 = tsne$Y[(ncol(sce.P15)+1):(ncol(sce.P15)+ncol(sce_early_RA)),2],
                  cell_type = colData(sce_early_RA)$cell_type),
             aes(tSNE1, tSNE2, colour = cell_type, size = 3)) +
  scale_color_manual(values = c(metadata(sce.P15)$colour_vector.P15,
                                metadata(sce_early_RA)$colour_vector_RA, "NewCell" = "black"))
```

# Save final figure

```{r save}
A <- plot_grid(Gfra1 + theme(legend.position=c(.05,.8)), Nanos3+ theme(legend.position=c(.05,.8)), Stra8+ theme(legend.position=c(.05,.8)), Dmrtb1+ theme(legend.position=c(.05,.8)), samples+ theme(legend.position=c(.05,.8)), p.clusters + theme(legend.position=c(.05,.8)), ncol = 6)
B_legend1 <- get_legend(empty_drops + theme(legend.position="bottom"))
B_legend2 <- get_legend(empty_drops_RA + theme(legend.position="bottom"))
B_legend3 <- get_legend(empty_drops_clustered + theme(legend.position = "bottom"))
B <- plot_grid(empty_drops+ theme(legend.position="none"), empty_drops_RA+ theme(legend.position="none"), empty_drops_clustered+ theme(legend.position="none"), B_legend1, B_legend2, B_legend3, ncol = 3, nrow = 2, rel_heights = c(4,1))
final <- plot_grid(A, B, nrow=2, rel_heights = c(1,2))

ggsave("../../../Dropbox (Cambridge University)/SST_spermatocytes/Revisions/Results/New_figures/Fig_3/Fig_3.pdf",
       final, width = 25, height = 20)
```