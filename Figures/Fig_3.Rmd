---
title: "Figure 3"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 2
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, 
        encoding = encoding, output_file = '/Users/nils/Dropbox (Cambridge University)/SST_spermatocytes/Analysis/Figures/Fig_S3/Fig_3.html') })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Read in the data

```{r data, message=FALSE}
library(scater)
library(ggplot2)
library(reshape2)
library(plyr)
library(openxlsx)
library(cowplot)
library(viridis)
library(pheatmap)
source("../Functions/auxiliary.R")

# Single cell data
sce <- readRDS("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/10X_data/SCE_all.rds")
```

# Visualize spermatogonia from P10 and P15

## Peform bacth correction on spermatogonia pf P10 and P15

```{r}
# To avoid batch effects between the samples, we assume that there are 
# shared cell types between the samples
sce.spermatogonia.p10.15 <- sce[,grepl("P1", colData(sce)$Sample) &
                                       colData(sce)$AnnotatedClusters == "Spermatogonia"]
sce.spermatogonia.p10.15 <- normalize(sce.spermatogonia.p10.15)
rm(sce)

sce.single <- split.sce(sce = sce.spermatogonia.p10.15, 
                        groups = unique(colData(sce.spermatogonia.p10.15)$Library), 
                        colData.name = "Library")

corrected <- batch.correction(sce.single)
```

```{r, spermatogonia_p10_p15}
# Compute pca 
pca.P10.15 <- prcomp(t(corrected))

# Visualize PCA with marker genes
ggplot(data.frame(PC1 = pca.P10.15$x[,1],
                  PC2 = pca.P10.15$x[,2],
                  samples = colData(sce.spermatogonia.p10.15)$Sample)) +
  geom_point(aes(PC1, PC2, colour = samples)) 

# For visualization the non-batch corrected counts are used

#Nanos3 marker for undifferentiated spermatogonia
Nanos3.P10.15 <- ggplot(data.frame(PC1 = pca.P10.15$x[,1],
                  PC2 = pca.P10.15$x[,2],
                  Nanos3 = logcounts(sce.spermatogonia.p10.15)[
                    rowData(sce.spermatogonia.p10.15)$Symbol == "Nanos3",])) +
  geom_point(aes(PC1, PC2, colour = Nanos3)) + scale_colour_viridis()

#NZbtb16/PLZF marker for undifferentiated spemratogonia but was also found in spermatogonia alreadt expressing Stra8
Zbtb16.P10.15 <- ggplot(data.frame(PC1 = pca.P10.15$x[,1],
                  PC2 = pca.P10.15$x[,2],
                  Zbtb16 = logcounts(sce.spermatogonia.p10.15)[
                    rowData(sce.spermatogonia.p10.15)$Symbol == "Zbtb16",])) +
  geom_point(aes(PC1, PC2, colour = Zbtb16)) + scale_colour_viridis()

# Induced by RA and upregulated during spermatogonial differentiation and again later on in preleptotene spermatocytes
Stra8.P10.15 <- ggplot(data.frame(PC1 = pca.P10.15$x[,1],
                  PC2 = pca.P10.15$x[,2],
                  Stra8 = logcounts(sce.spermatogonia.p10.15)[
                    rowData(sce.spermatogonia.p10.15)$Symbol == "Stra8",])) +
  geom_point(aes(PC1, PC2, colour = Stra8)) + scale_colour_viridis()

# Ccnd2 for spermatogonial differentiation and Ccnd1 in proliferating spermatogonia
Ccnd2.P10.15 <- ggplot(data.frame(PC1 = pca.P10.15$x[,1],
                  PC2 = pca.P10.15$x[,2],
                  Ccnd2 = logcounts(sce.spermatogonia.p10.15)[
                    rowData(sce.spermatogonia.p10.15)$Symbol == "Ccnd2",])) +
  geom_point(aes(PC1, PC2, colour = Ccnd2)) + scale_colour_viridis()

Ccnd1.P10.15 <- ggplot(data.frame(PC1 = pca.P10.15$x[,1],
                  PC2 = pca.P10.15$x[,2],
                  Ccnd1 = logcounts(sce.spermatogonia.p10.15)[
                    rowData(sce.spermatogonia.p10.15)$Symbol == "Ccnd1",])) +
  geom_point(aes(PC1, PC2, colour = Ccnd1)) + scale_colour_viridis()

# Rhox13 higher in differentiating spermatogonia
Rhox13.P10.15 <- ggplot(data.frame(PC1 = pca.P10.15$x[,1],
                  PC2 = pca.P10.15$x[,2],
                  Rhox13 = logcounts(sce.spermatogonia.p10.15)[
                    rowData(sce.spermatogonia.p10.15)$Symbol == "Rhox13",])) +
  geom_point(aes(PC1, PC2, colour = Rhox13)) + scale_colour_viridis()

```

# Clustering of spermatogonia for P10 and P15

```{r}
# Use the same graph based clustering technique
g <- buildSNNGraph(corrected, k = 15, pc.approx = TRUE)

clusters <- igraph::cluster_louvain(g)$membership

# Change cluster labels
clusters[clusters == 1] <- "Trans_2"
clusters[clusters == 2] <- "Trans_3"
clusters[clusters == 3] <- "Undifferentiated_SPG"
clusters[clusters == 4] <- "Unknown"
clusters[clusters == 5] <- "Trans_1"
clusters[clusters == 6] <- "Preleptotene"

col_vector <- c("Undifferentiated_SPG" = "#00441b",
                "Trans_1" = "#238b45",
                "Trans_2" = "#66c2a4",
                "Trans_3" = "#ccece6",
                "Preleptotene" = "#d4b9da",
                "Unknown" = "#ccebc5")

p.clusters <- ggplot(data.frame(PC1 = pca.P10.15$x[,1],
                  PC2 = pca.P10.15$x[,2],
                  clusters = as.factor(clusters))) +
  geom_point(aes(PC1, PC2, colour = clusters))+ scale_colour_manual(values = col_vector)
```

# Find marker genes for these groups

```{r}
spermatogonia.markers <- marker.detection(sce.spermatogonia.p10.15, 
                                          clusters)

write.xlsx(spermatogonia.markers, "../../../Dropbox (Personal)/Tc1_meiotic_silencing/Figures/Supplemental Tables/Table_S4.xlsx")
```

# Visualize marker genes

```{r}
# First we order the cells based on their differerentiation trajectory
prank <- PT(rd = pca.P10.15$x[,1:3], clusters = clusters, col_vector = col_vector)

# Collect count for heatmap
cur_markers <- spermatogonia.markers[c("Undifferentiated_SPG", "Unknown", "Trans_1",
                                       "Trans_2", "Trans_3", "Preleptotene")]
genes <- as.character(unlist(lapply(cur_markers, function(n){rownames(n)[1:10]})))
for.heatmap <- logcounts(sce.spermatogonia.p10.15)[genes,
                                      order(prank[,"rank"], decreasing = TRUE)]
colnames(for.heatmap) <- paste(colData(sce.spermatogonia.p10.15)$Library[
  order(prank[,"rank"], decreasing = TRUE)],
  colData(sce.spermatogonia.p10.15)$Barcode[
  order(prank[,"rank"], decreasing = TRUE)], sep = "_")

# Visualize top genes in form of heatmap
pdf("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/Figures/Fig_3/Spermatogonia_heatmap_P10_P15.pdf", onefile = FALSE, width = 10, height = 15)
pheatmap(for.heatmap, 
         cluster_rows = FALSE, cluster_cols = FALSE,
         scale = "row",
         show_colnames = FALSE, gaps_row = seq(10,50, 10),
         cellheight = 8, fontsize = 7,
         color = colorRampPalette(c("#053061", "#4393c3", 
                                    "#f7f7f7", "#d6604d", "#67001f"))(100),
         labels_row = rowData(sce.spermatogonia.p10.15)$Symbol[match(rownames(for.heatmap),
                                                                     rowData(sce.spermatogonia.p10.15)$ID)],
         annotation_col = data.frame(row.names = colnames(for.heatmap),
                                     cell_type = clusters[order(prank[,"rank"], decreasing = TRUE)]),
         annotation_row = data.frame(row.names = rownames(for.heatmap),
                                     gene_list = rep(c("Undifferentiated_SPG", "Unknown", "Trans_1",
                                       "Trans_2", "Trans_3", "Preleptotene"), each = 10)),
         annotation_colors = list(cell_type = col_vector,
                                  gene_list = col_vector))
dev.off()
```

# Save final figure

```{r save}
B <- plot_grid(Nanos3.P10.15, Stra8.P10.15, Ccnd1.P10.15, p.clusters, ncol = 4, nrow = 1)

ggsave("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/Figures/Fig_3/Fig_3.pdf",
       B, width = 20, height = 5)
```