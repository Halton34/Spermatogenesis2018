---
title: "Figure 3"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 2
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, 
        encoding = encoding, output_file = '/Users/nils/Dropbox (Cambridge University)/SST_spermatocytes/Analysis/Figures/Fig_S3/Fig_3.html') })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Read in the data

```{r data, message=FALSE}
library(scater)
library(ggplot2)
library(reshape2)
library(plyr)
library(openxlsx)
library(cowplot)
library(viridis)
library(pheatmap)
library(Rtsne)
library(irlba)
library(RColorBrewer)
source("../Functions/auxiliary.R")

# Single cell data
sce <- readRDS("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/10X_data/SCE_all.rds")

# Read in markers for spermatogonia
sperm.markers <- read.xlsx("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/Figures/Fig_3/Spermatogonia_Top15.xlsx")
```

# Visualize spermatogonia from P10 and P15

## Peform bacth correction on spermatogonia pf P10 and P15

```{r}
# To avoid batch effects between the samples, we assume that there are 
# shared cell types between the samples
sce.spermatogonia <- sce[,grepl("P5|P10|P15", colData(sce)$Sample) &
                                       colData(sce)$AnnotatedClusters == "Spermatogonia"]
sce.spermatogonia <- normalize(sce.spermatogonia)
rm(sce)

# Visualize non-batch corrected data
sce.spermatogonia <- runPCA(sce.spermatogonia)
ggplot(data.frame(PC1 = reducedDims(sce.spermatogonia)$PCA[,1],
                  PC2 = reducedDims(sce.spermatogonia)$PCA[,2],
                  samples = colData(sce.spermatogonia)$Sample)) +
  geom_point(aes(PC1, PC2, colour = samples)) + 
  scale_color_manual(values = c("#1f78b4", "#33a02c", "#e31a1c"))

ggplot(data.frame(PC1 = reducedDims(sce.spermatogonia)$PCA[,1],
                  PC2 = reducedDims(sce.spermatogonia)$PCA[,2],
                  Nanos3 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Stra8",])) +
  geom_point(aes(PC1, PC2, colour = Nanos3)) + scale_colour_viridis()

sce.single <- split.sce(sce = sce.spermatogonia, 
                        groups = unique(colData(sce.spermatogonia)$Library), 
                        colData.name = "Library")

# Use P10 as first sample
corrected <- batch.correction(sce.single[c("do17821", "do18195", "do26386", "do26387")])

sce.spermatogonia <- do.call(cbind, sce.single[c("do17821", "do18195", "do26386", "do26387")])
```

```{r, spermatogonia_p10_p15}
# Compute pca 
pca <- prcomp(t(corrected))
tsne <- Rtsne(t(corrected))

# Visualize PCA with marker genes
samples <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  samples = colData(sce.spermatogonia)$Sample)) +
  geom_point(aes(PC1, PC2, colour = samples)) + 
  scale_color_manual(values = c("#1f78b4", "#33a02c", "#e31a1c")) 

samples.tsne <- ggplot(data.frame(tsne1 = tsne$Y[,1],
                  tsne2 = tsne$Y[,2],
                  samples = colData(sce.spermatogonia)$Sample)) +
  geom_point(aes(tsne1, tsne2, colour = samples)) + 
  scale_color_manual(values = c("#1f78b4", "#33a02c", "#e31a1c")) 

gene.tsne <- ggplot(data.frame(tsne1 = tsne$Y[,1],
                  tsne2 = tsne$Y[,2],
                  gene = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Ccnd1",])) +
  geom_point(aes(tsne1, tsne2, colour = gene)) + scale_colour_viridis()

# For visualization the non-batch corrected counts are used

#Nanos3 marker for undifferentiated pca
Nanos3 <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  Nanos3 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Nanos3",])) +
  geom_point(aes(PC1, PC2, colour = Nanos3)) + scale_colour_viridis()

#NZbtb16/PLZF marker for undifferentiated spemratogonia but was also found in spermatogonia alreadt expressing Stra8
Zbtb16 <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  Zbtb16 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Zbtb16",])) +
  geom_point(aes(PC1, PC2, colour = Zbtb16)) + scale_colour_viridis()

# Induced by RA and upregulated during spermatogonial differentiation and again later on in preleptotene spermatocytes
Stra8 <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  Stra8 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Stra8",])) +
  geom_point(aes(PC1, PC2, colour = Stra8)) + scale_colour_viridis()

# Ccnd2 for spermatogonial differentiation and Ccnd1 in proliferating spermatogonia
Ccnd2 <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  Ccnd2 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Ccnd2",])) +
  geom_point(aes(PC1, PC2, colour = Ccnd2)) + scale_colour_viridis()

Ccnd1 <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  Ccnd1 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Ccnd1",])) +
  geom_point(aes(PC1, PC2, colour = Ccnd1)) + scale_colour_viridis()

# Rhox13 higher in differentiating spermatogonia
Rhox13 <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  Rhox13 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Rhox13",])) +
  geom_point(aes(PC1, PC2, colour = Rhox13)) + scale_colour_viridis()


#Dmrtb1 mediates mitosis-to-meiosis 
Dmrtb1 <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  Dmrtb1 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Dmrtb1",])) +
  geom_point(aes(PC1, PC2, colour = Dmrtb1)) + scale_colour_viridis()

Gfra1 <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  Gfra1 = logcounts(sce.spermatogonia)[
                    rowData(sce.spermatogonia)$Symbol == "Gfra1",])) +
  geom_point(aes(PC1, PC2, colour = Gfra1)) + scale_colour_viridis()
```

# Clustering of spermatogonia for P5, P10 and P15

```{r}
# Use the same graph based clustering technique
set.seed(123)
g <- buildSNNGraph(corrected, k = 15, pc.approx = TRUE)
clusters <- igraph::cluster_louvain(g)$membership

# Change cluster labels
clusters[clusters == 1] <- "Diff_2"
clusters[clusters == 2] <- "Undiff_3"
clusters[clusters == 3] <- "Diff_3"
clusters[clusters == 4] <- "Diff_1"
clusters[clusters == 5] <- "Undiff_1"
clusters[clusters == 6] <- "Undiff_2"


col_vector <- c("Undiff_1" = "#001c0b",
                "Undiff_2" = "#00441b",
                "Diff_1" = "#238b45",
                "Diff_2" = "#41ae76",
                "Diff_3" = "#66c2a4",
                "Undiff_3" = "#006d2c")

p.clusters <- ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  clusters = as.factor(clusters))) +
  geom_point(aes(PC1, PC2, colour = clusters))+ scale_colour_manual(values = col_vector)
```

# Find marker genes for these groups

```{r}
spermatogonia.markers <- marker.detection(sce.spermatogonia, 
                                          clusters)

spermatogonia.markers.P5 <- marker.detection(sce.spermatogonia[,sce.spermatogonia$Sample == "P5"], 
                                          clusters[sce.spermatogonia$Sample == "P5"])

write.xlsx(spermatogonia.markers, "../../../Dropbox (Cambridge University)/SST_spermatocytes/Revisions/Results/New_figures/Supplemental_tables/Table_S4.xlsx")
write.xlsx(spermatogonia.markers.P5, "../../../Dropbox (Cambridge University)/SST_spermatocytes/Revisions/Results/New_figures/Supplemental_tables/Table_S4_P5.xlsx")
```

# Visualize RA blocked cells on empty drops

```{r}
# Read in RA blocked cell data from Chen et al, Cell Research
files <- list.files("../../../Dropbox (Cambridge University)/SST_spermatocytes/Revisions/Data/Chen_CellResearch/GSE107644_RAW/", full.names = TRUE)

all_cells <- lapply(as.list(files), function(n){
  cur_file <- read.table(n, sep = "\t", header = TRUE)
  rownames(cur_file) <- cur_file[,1]
  cur_file <- cur_file[,-1]
})

all_cells <- do.call("cbind", all_cells)

# Form a sce 
sce_RA <- SingleCellExperiment(assays=list(counts=Matrix::Matrix(as.matrix(all_cells), sparse = TRUE)))
colData(sce_RA)$time_point <- factor(as.character(sapply(colnames(sce_RA), 
                                                         function(n){unlist(strsplit(n, "_"))[1]})),
                                        levels = paste("SpSC", c(0, 2:37), sep = "")) 
colData(sce_RA)$cell_type <- as.character(sapply(colnames(sce_RA), function(n){unlist(strsplit(n, "_"))[2]})) 

# P15 data
sce <- readRDS("../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/10X_data/SCE_emptyDrops.rds")
sce <- sce[,grepl("P15", colData(sce)$Sample)]

# QC on RA cells
sce_RA <- calculateQCMetrics(sce_RA)

ggplot(as.data.frame(colData(sce_RA))) + 
  geom_point(aes(total_features_by_counts, log10_total_counts, colour = time_point))

# Remove 2 cells with few features and one cell with high features detected
sce_RA <- sce_RA[,colData(sce_RA)$total_features_by_counts > 1250 &
                   colData(sce_RA)$total_features_by_counts < 12000]

# Normalization of RA cells
clusters <- quickCluster(sce_RA, method = "igraph", irlba.args = c("work" = 100), 
                         max.size = 1000)

sce_RA <- computeSumFactors(sce_RA, clusters=clusters)

sce_RA <- normalize(sce_RA, return_log = TRUE)

# Batch correction
sce <- sce[match(intersect(rownames(sce_RA), rowData(sce)$Symbol), rowData(sce)$Symbol),]
sce_RA <- sce_RA[match(intersect(rownames(sce_RA), rowData(sce)$Symbol), rownames(sce_RA)),]

rownames(sce_RA) <- rownames(sce)
rowData(sce_RA)$Symbol <- rowData(sce)$Symbol
rowData(sce_RA)$ID <- rowData(sce)$ID

# Select only the germ cells
sce.P15 <- sce[,grepl("Pachytene|Differentiating|Zygotene|Leptotene|Undifferentiated", colData(sce)$P15Clusters) &
                 colData(sce)$AnnotatedClusters != "Outliers"]
sce.P15 <- normalize(sce.P15)

# Select Early germ cells from RA blocked cells
sce_early_RA <- sce_RA[,grepl("A1|ePL|G1|mPL|eP|mP|lPL|Z|L|ln|Spo11KOL1", colData(sce_RA)$cell_type)]
sce_early_RA <- normalize(sce_early_RA)

# Batch correction
# Calculate highly variable genes
HVG.genes <- lapply(list(sce.P15, sce_early_RA), function(n){
    HVG <- trendVar(n, use.spikes = FALSE)
    decomposeVar(n, HVG)
  })
  
HVG.df <- do.call("combineVar", HVG.genes)
HVG.df <- HVG.df[order(HVG.df$bio, decreasing = TRUE),]
genes <- rownames(HVG.df)[1:1000]
  
# Batch correction
corrected <- mnnCorrect(as.matrix(logcounts(sce.P15)[genes,]),
                        as.matrix(logcounts(sce_early_RA)[genes,]), 
                        cos.norm.in=TRUE, cos.norm.out=TRUE, sigma=0.1)

# Assign mutual nearest neighbours in P15 sample with cell identity from RA blocked cells
new.cellID <- vector(length = ncol(sce.P15))
new.cellID[as.integer(corrected$pairs[[2]]$other.cell)] <- sce_early_RA$cell_type[as.integer(corrected$pairs[[2]]$current.cell)]
new.cellID[new.cellID == "FALSE"] <- "NewCell"
colData(sce.P15)$RA_blocked_identity <- new.cellID

# Visualization
set.seed(111)
pca <- prcomp_irlba(t(do.call("cbind", corrected$corrected)), n = 50)
tsne <- Rtsne(pca$x, pca = FALSE, perplexity = 50)

# CellRanger filter cluster
# Create new colour vector
new_vector <- c(brewer.pal(n = 8, name = "Set1"), brewer.pal(n = 8, name = "Set2"))
names(new_vector) <- unique(colData(sce_early_RA)$cell_type)
col_vector <- c(metadata(sce)$color_vector, new_vector)

empty_drops_RA <- ggplot() +
  geom_point(data = data.frame(tSNE1 = tsne$Y[1:ncol(sce.P15),1],
                  tSNE2 = tsne$Y[1:ncol(sce.P15),2],
                  cluster = colData(sce.P15)$AnnotatedClusters),
             aes(tSNE1, tSNE2, colour = cluster)) + 
    geom_point(data = data.frame(tSNE1 = tsne$Y[(ncol(sce.P15)+1):(ncol(sce.P15)+ncol(sce_early_RA)),1],
                  tSNE2 = tsne$Y[(ncol(sce.P15)+1):(ncol(sce.P15)+ncol(sce_early_RA)),2],
                  cell_type = colData(sce_early_RA)$cell_type),
             aes(tSNE1, tSNE2, colour = cell_type, size = 3)) +
  scale_color_manual(values = col_vector)

new_vector <- c(brewer.pal(n = 8, name = "Set1"), brewer.pal(n = 8, name = "Set2"))
names(new_vector) <- unique(colData(sce_early_RA)$cell_type)
col_vector <- c(metadata(sce)$colour_vector.P15, new_vector)

empty_drops_clustered <- ggplot() +
  geom_point(data = data.frame(tSNE1 = tsne$Y[1:ncol(sce.P15),1],
                  tSNE2 = tsne$Y[1:ncol(sce.P15),2],
                  cluster = colData(sce.P15)$P15Clusters),
             aes(tSNE1, tSNE2, colour = cluster)) + 
    geom_point(data = data.frame(tSNE1 = tsne$Y[(ncol(sce.P15)+1):(ncol(sce.P15)+ncol(sce_early_RA)),1],
                  tSNE2 = tsne$Y[(ncol(sce.P15)+1):(ncol(sce.P15)+ncol(sce_early_RA)),2],
                  cell_type = colData(sce_early_RA)$cell_type),
             aes(tSNE1, tSNE2, colour = cell_type, size = 3)) +
  scale_color_manual(values = col_vector)
```

# Save final figure

```{r save}
A <- plot_grid(Nanos3, Stra8, Dmrtb1, p.clusters, samples, ncol = 5, nrow = 1)
B <- plot_grid(empty_drops_RA, empty_drops_clustered, ncol = 2, nrow = 1)
final <- plot_grid(A, B, nrow = 2, rel_heights = c(1,2))

ggsave("../../../Dropbox (Cambridge University)/SST_spermatocytes/Revisions/Results/New_figures/Fig_3/Fig_3.pdf",
       final, width = 25, height = 20)
```