---
title: "Figure S4"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 2
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, 
        encoding = encoding, output_file = '/Users/nils/Dropbox (Cambridge University)/SST_spermatocytes/Analysis/Figures/Fig_S4/Fig_S4.html') })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Read in the data

```{r data, message=FALSE}
library(scater)
library(ggplot2)
library(reshape2)
library(plyr)
library(openxlsx)
library(cowplot)
library(viridis)
library(pheatmap)
source("../Functions/auxiliary.R")

# Single cell data
sce <- readRDS("/Users/nils/Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/10X_data/SCE_all.rds")
```

# Visualize emptyDrops

```{r emptyDrops}
sce <- readRDS("/Users/nils/Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/10X_data/SCE_emptyDrops.rds")
no.genes <- nexprs(sce, detection_limit = 0)

# Collect marker genes expression in correct order
df1 <- data.frame(tsne1 =reducedDims(sce)$TSNE[
                      colData(sce)$AnnotatedClusters != "NewCell",1],
                  tsne2 = reducedDims(sce)$TSNE[
                    colData(sce)$AnnotatedClusters != "NewCell",2],
                  batch = colData(sce)$AnnotatedClusters[
                    colData(sce)$AnnotatedClusters != "NewCell"
                  ],
                  sample = colData(sce)$Sample[
                    colData(sce)$AnnotatedClusters != "NewCell"
                  ],
                  Sycp1 = logcounts(sce)[rowData(sce)$Symbol == "Sycp1",
                  colData(sce)$AnnotatedClusters != "NewCell"],
                  H2afx  = logcounts(sce)[rowData(sce)$Symbol == "H2afx",
                  colData(sce)$AnnotatedClusters != "NewCell"],
                  Hormad1 =  logcounts(sce)[rowData(sce)$Symbol == "Hormad1",
                  colData(sce)$AnnotatedClusters != "NewCell"],
                  no.genes = no.genes[
                  colData(sce)$AnnotatedClusters != "NewCell"])
df2 <- data.frame(tsne1 =reducedDims(sce)$TSNE[
                      colData(sce)$AnnotatedClusters == "NewCell",1],
                  tsne2 = reducedDims(sce)$TSNE[
                    colData(sce)$AnnotatedClusters == "NewCell",2],
                  batch = colData(sce)$AnnotatedClusters[
                    colData(sce)$AnnotatedClusters == "NewCell"
                  ],
                  sample = colData(sce)$Sample[
                    colData(sce)$AnnotatedClusters == "NewCell"
                  ],
                  Sycp1 = logcounts(sce)[rowData(sce)$Symbol == "Sycp1",
                  colData(sce)$AnnotatedClusters == "NewCell"],
                  H2afx  = logcounts(sce)[rowData(sce)$Symbol == "H2afx",
                  colData(sce)$AnnotatedClusters == "NewCell"],
                  Hormad1 =  logcounts(sce)[rowData(sce)$Symbol == "Hormad1",
                  colData(sce)$AnnotatedClusters == "NewCell"],
                  no.genes = no.genes[
                  colData(sce)$AnnotatedClusters == "NewCell"])
  
# All samples
emptyDrops <- ggplot() +
  geom_point(data = df2, aes(tsne1, tsne2, colour = batch), size = 0.5) +
  geom_point(data = df1, aes(tsne1, tsne2, colour = batch), size = 0.5) +
  scale_color_manual(values = metadata(sce)$color_vector) +
  guides(colour = FALSE)

# Only P20
emptyDrops.P20 <- ggplot() +
  geom_point(data = df2[grepl("P20", df2$sample),], 
             aes(tsne1, tsne2, colour = batch), size = 0.5) +
  geom_point(data = df1[grepl("P20", df1$sample),], 
             aes(tsne1, tsne2, colour = batch), size = 0.5) +
  scale_color_manual(values = metadata(sce)$color_vector) +
  guides(colour = FALSE)

emptyDrops.Sycp1 <- ggplot() +
  geom_point(data = df2, aes(tsne1, tsne2, colour = Sycp1), size = 0.5) +
  geom_point(data = df1, aes(tsne1, tsne2, colour = Sycp1), size = 0.5) +
  scale_color_viridis()

emptyDrops.H2afx <- ggplot() +
  geom_point(data = df2, aes(tsne1, tsne2, colour = H2afx), size = 0.5) +
  geom_point(data = df1, aes(tsne1, tsne2, colour = H2afx), size = 0.5) +
  scale_color_viridis()

emptyDrops.Hormad1 <- ggplot() +
  geom_point(data = df2, aes(tsne1, tsne2, colour = Hormad1), size = 0.5) +
  geom_point(data = df1, aes(tsne1, tsne2, colour = Hormad1), size = 0.5) +
  scale_color_viridis()

# Number of genes expressed
emptyDrops.no.genes <- ggplot() +
  geom_point(data = df2, aes(tsne1, tsne2, colour = no.genes), size = 0.5) +
  geom_point(data = df1, aes(tsne1, tsne2, colour = no.genes), size = 0.5) +
  scale_color_gradientn(colours = inferno(100))
```

# Save final figure

```{r save}
B <- plot_grid(Nanos3, Stra8, Rhox13, ncol = 3, nrow = 1, 
               labels = c("B", NULL, NULL))
C <- plot_grid(emptyDrops, emptyDrops.P20, NULL, ncol = 3, nrow = 1, 
               labels = c("C", NULL, NULL))
D <- plot_grid(emptyDrops.Sycp1, emptyDrops.H2afx, emptyDrops.Hormad1, ncol = 3, nrow = 1, 
               labels = c("D", NULL, NULL))
E <- plot_grid(emptyDrops.no.genes, NULL, NULL, ncol = 3, nrow = 1, 
               labels = c("E", NULL, NULL))
final <- plot_grid(B, C, D, E,
                   ncol = 1, nrow = 4)

ggsave("/Users/nils/Dropbox (Cambridge University)/SST_spermatocytes/Analysis/Figures/Fig_S4/Fig_S4.pdf",
       width = 15, height = 15)
```