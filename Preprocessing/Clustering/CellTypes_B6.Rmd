---
title: "Cell types in 10X data"
author: "Nils Eling"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_depth: 2
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, 
        encoding = encoding, output_file = '/Users/nils/Dropbox (Cambridge University)/SST_spermatocytes/Analysis/10X/Preprocessing/CellTypeIdentification/CellTypesB6.html') })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data preparation

To discover all cell-types in the 10X data, we will use the sorted C1 data as refernce

```{r load, message=FALSE}
# Load libraries and data
library(Matrix)
library(openxlsx)
library(RColorBrewer)
library(viridis)
library(ggsci)
source("../../Functions/auxiliary.R")

# Wild type 10X data
sce <- readRDS("../../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/10X_data/SCE_all_unfiltered.rds")
sce.B6 <- sce[,grepl("B6", colData(sce)$Sample)]
sce.B6 <- sce.B6[Matrix::rowMeans(counts(sce.B6)) > 0.1,]
sce.B6 <- normalize(sce.B6)
```

# Broad cluster detection

Detect braod clusters during differentiation in 10X wildtype cells.

```{r}
# Compute highly variable genes - auxiliary functions
HVG.genes <- HVG(sce.B6)

# Cluster data - auxiliary functions
ct <- DTC(sce.B6, HVG.genes)

# Recalculate tsne
set.seed(123)
sce.B6 <- scater::runTSNE(sce.B6)

ggplot(data.frame(tSNE1 = reducedDims(sce.B6)$TSNE[,1],
                  tSNE2 = reducedDims(sce.B6)$TSNE[,2],
                  sample = as.factor(ct))) +
  geom_point(aes(tSNE1, tSNE2, colour = sample))

# Find marker genes for each cluster
markers <- marker.detection(sce.B6, ct)

write.xlsx(markers, file = "../../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/10X/Results/Marker_genes/BroadGroups_B6.xlsx")

colData(sce.B6)$broad_clusters <- ct
```

# Subpopulation detection

```{r}
# Split sce into subgroups
all.sce <- split.sce(sce.B6, groups = unique(ct), colData.name = "broad_clusters")

# Calculate HVG
all.HVG.genes <- HVG(all.sce)

# Cluster each group
all.ct <- DTC(all.sce, all.HVG.genes, deepSplit = 1)

# Visualize all groups
clusters <- unlist(all.ct)
names(clusters) <- sapply(names(clusters), function(n){unlist(strsplit(n, "\\."))[2]})
clusters <- clusters[colData(sce.B6)$Barcode]

# Broad clusters
ggplot(data.frame(tSNE1 = reducedDims(sce.B6)$TSNE[,1],
                  tSNE2 = reducedDims(sce.B6)$TSNE[,2],
                  sample = as.factor(colData(sce.B6)$broad_clusters))) +
  geom_point(aes(tSNE1, tSNE2, colour = sample))

# Subclusters
col_vector <- c(brewer.pal(8, name = "Set1"), brewer.pal(8, name = "Set2"),
                                brewer.pal(8, name = "Set3"))
names(col_vector) <- unique(clusters)
ggplot(data.frame(tSNE1 = reducedDims(sce.B6)$TSNE[,1],
                  tSNE2 = reducedDims(sce.B6)$TSNE[,2],
                  sample = as.factor(clusters))) +
  geom_point(aes(tSNE1, tSNE2, colour = sample)) + 
  scale_color_manual(values = col_vector)


# Visualize marker genes
ggplot(data.frame(tsne1 = reducedDims(sce.B6)$TSNE[,1],
                  tsne2 = reducedDims(sce.B6)$TSNE[,2],
                  gene = logcounts(sce.B6)[rowData(sce.B6)$ID[rowData(sce.B6)$Symbol == "Stra8"],])) +
  geom_point(aes(tsne1, tsne2, colour = gene)) + scale_color_viridis()

ggplot(data.frame(tsne1 = reducedDims(sce.B6)$TSNE[,1],
                  tsne2 = reducedDims(sce.B6)$TSNE[,2],
                  gene = logcounts(sce.B6)[rowData(sce.B6)$ID[rowData(sce.B6)$Symbol == "Pou5f2"],])) +
  geom_point(aes(tsne1, tsne2, colour = gene)) + scale_color_viridis()

# Defb19 
ggplot(data.frame(tsne1 = reducedDims(sce.B6)$TSNE[,1],
                  tsne2 = reducedDims(sce.B6)$TSNE[,2],
                  gene = logcounts(sce.B6)[rowData(sce.B6)$ID[rowData(sce.B6)$Symbol == "Defb19"],])) +
  geom_point(aes(tsne1, tsne2, colour = gene)) + scale_color_viridis()

# Prm1 
ggplot(data.frame(tsne1 = reducedDims(sce.B6)$TSNE[,1],
                  tsne2 = reducedDims(sce.B6)$TSNE[,2],
                  gene = logcounts(sce.B6)[rowData(sce.B6)$ID[rowData(sce.B6)$Symbol == "Prm1"],])) +
  geom_point(aes(tsne1, tsne2, colour = gene)) + scale_color_viridis()

# Dazl 
ggplot(data.frame(tsne1 = reducedDims(sce.B6)$TSNE[,1],
                  tsne2 = reducedDims(sce.B6)$TSNE[,2],
                  gene = logcounts(sce.B6)[rowData(sce.B6)$ID[rowData(sce.B6)$Symbol == "Dazl"],])) +
  geom_point(aes(tsne1, tsne2, colour = gene)) + scale_color_viridis()
```

# Ordering based on pseudotime

Here, we rename the clusters based on their appearance over pseudotime.

```{r}
new.clusters <- vector(length = length(clusters))
names(new.clusters) <- names(clusters)

# Visualize first few PCs
pca <- prcomp(t(logcounts(sce.B6)[HVG.genes,] + 1))
plot(pca)

ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  sample = as.factor(clusters))) +
  geom_point(aes(PC1, PC2, colour = sample)) + 
  scale_color_manual(values = col_vector)

ggplot(data.frame(PC1 = pca$x[,1],
                  PC3 = pca$x[,3],
                  sample = as.factor(clusters))) +
  geom_point(aes(PC1, PC3, colour = sample)) + 
  scale_color_manual(values = col_vector)

ggplot(data.frame(PC2 = pca$x[,2],
                  PC3 = pca$x[,3],
                  sample = as.factor(clusters))) +
  geom_point(aes(PC2, PC3, colour = sample)) + 
  scale_color_manual(values = col_vector)

# Perform density clustering to remove outliers
dbs <- dbscan(pca$x[,1:3], eps = 4)

ggplot(data.frame(PC1 = pca$x[,1],
                  PC2 = pca$x[,2],
                  sample = as.factor(dbs$cluster))) +
  geom_point(aes(PC1, PC2, colour = sample)) 

new.clusters[dbs$cluster == 0] <- "Outliers"

# Somatic cells
new.clusters[clusters == "2_6"] <- "1"

# Spermatogonia
new.clusters[clusters == "2_7"] <- "2"

# Calculate pseudotime across PC1 - PC3 - excluding somatic cells and
# spermatogonia and outliers
PT.B6 <- PT(rd = pca$x[,1:3], clusters = clusters,
            col_vector = col_vector, exclude = clusters %in% c("2_6", "2_7") | 
                                                      new.clusters == "Outliers")

plot(PT.B6[,"rank"], PT.B6[,"PC1"], col = col_vector[clusters])

# Compute median rank for each cluster
pos.PT <- vector(length = length(unique(clusters)))
names(pos.PT) <- unique(clusters)

for(i in 1:length(unique(clusters))){
  pos.PT[i] <- median(PT.B6[clusters == names(pos.PT)[i], "rank"], na.rm = TRUE)
}

pos.PT[order(pos.PT)]
pos.PT <- pos.PT[!is.na(pos.PT)]

# Rename subclusters based on their position on pseudotime
counter <- 3
for(i in rev(names(pos.PT[order(pos.PT)]))){
  new.clusters[clusters == i & new.clusters != "Outliers"] <- as.numeric(counter)
  counter <- counter + 1
}

# Visualize all subcluster
ggplot(data.frame(tSNE1 = reducedDims(sce.B6)$TSNE[,1],
                  tSNE2 = reducedDims(sce.B6)$TSNE[,2],
                  sample = factor(new.clusters, 
                                     levels = c(1:23, "Outliers")))) +
  geom_point(aes(tSNE1, tSNE2, colour = sample)) + 
  scale_color_manual(values = col_vector)

# Save sub cluster info and indicate outliers in in broad clusters
colData(sce.B6)$subclusters <- new.clusters
colData(sce.B6)$broad_clusters[new.clusters == "Outliers"] <- "Outliers"
```

# Find marker genes

```{r marker}
# Remove outliers first
markers <- marker.detection(sce.B6[,colData(sce.B6)$subclusters != "Outliers"], 
        colData(sce.B6)$subclusters[colData(sce.B6)$subclusters != "Outliers"])


saveRDS(markers, "../../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/10X/Results/Marker_genes/All_markers.rds")

# Write out marker genes
openxlsx::write.xlsx(markers, file = "../../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/10X/Results/Marker_genes/SubGroups.xlsx")

# Save cluster IDs
colData(sce)$BroadCluster <- NA
colData(sce)$BroadCluster[grepl("B6", colData(sce)$Sample)] <- colData(sce.B6)$broad_clusters
colData(sce)$SubCluster <- NA
colData(sce)$SubCluster[grepl("B6", colData(sce)$Sample)] <- colData(sce.B6)$subclusters
```

```{r}
saveRDS(sce, "../../../../Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/10X_data/SCE_all.rds")
```


