---
title: "Clustering"
author: "Nils Eling"
output: 
  html_document:
    toc: true
    toc_depth: 2
knit: (function(inputFile, encoding) { rmarkdown::render(inputFile, 
        encoding = encoding, output_file = '/Users/nils/Dropbox (Cambridge University)/SST_spermatocytes/Analysis/10X/Preprocessing/QualityControl/Clustering.html') })
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Read the data and libraries

```{r data, message=FALSE}
library(scran)
library(scater)
library(dynamicTreeCut)
library(RColorBrewer)
library(dbscan)
source("../../Functions/auxiliary.R")

# Read in data
sce.all <- readRDS("/Users/nils/Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/10X_data/SCE_all_BatchCorrected.rds")
```

# Clustering on batch corrected counts

```{r clustering}
# Use the SNN approach
g <- buildSNNGraph(metadata(sce.all)$corrected, k = 3, pc.approx = TRUE)

clusters <- igraph::cluster_louvain(g)$membership

clusters[clusters == names(table(clusters))[table(clusters) < 30]] <- "Outliers"

# Visualize clustering
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
ggplot(data.frame(tsne1 = reducedDims(sce.all)$TSNE[,1],
                  tsne2 = reducedDims(sce.all)$TSNE[,2],
                  cluster = as.factor(clusters))) +
  geom_point(aes(tsne1, tsne2, colour = cluster)) +
  scale_color_manual(values = col_vector)

# Visualize sample
ggplot(data.frame(tsne1 = reducedDims(sce.all)$TSNE[,1],
                  tsne2 = reducedDims(sce.all)$TSNE[,2],
                  cluster = as.factor(colData(sce.all)$Sample))) +
  geom_point(aes(tsne1, tsne2, colour = cluster)) +
  scale_color_manual(values = col_vector)

colData(sce.all)$CLusters <- clusters
```

# Save sce

```{r save}
saveRDS(sce.all, "/Users/nils/Dropbox (Cambridge University)/SST_spermatocytes/Analysis/data/10X_data/SCE_all_clusters.rds")
```


# Annotation of clusters

```{r annotation}
new.clusters <- new.clusters
new.clusters[new.clusters == 1] <- "Sp_1"
new.clusters[new.clusters == 2] <- "ElSp_6"
new.clusters[new.clusters == 3] <- "Spermatocytes_2"
new.clusters[new.clusters == 4] <- "ElSp_5"
new.clusters[new.clusters == 5] <- "ElSp_4"
new.clusters[new.clusters == 7] <- "Spermatocytes_7"
new.clusters[new.clusters == 8] <- "Spermatocytes_1"
new.clusters[new.clusters == 9] <- "ElSp_2"
new.clusters[new.clusters == 10] <- "ElSp_1"
new.clusters[new.clusters == 11] <- ""
new.clusters[new.clusters == 12] <- ""
new.clusters[new.clusters == 13] <- "Spermatocytes_8"
new.clusters[new.clusters == 14] <- ""
new.clusters[new.clusters == 15] <- ""
new.clusters[new.clusters == 16] <- ""
new.clusters[new.clusters == 17] <- "Spermatocytes_4"
new.clusters[new.clusters == 18] <- "Spermatocytes_6"
new.clusters[new.clusters == 19] <- ""
new.clusters[new.clusters == 20] <- "Sp_3"
new.clusters[new.clusters == 21] <- "ElSp_3"
new.clusters[new.clusters == 22] <- ""
new.clusters[new.clusters == 23] <- "Spermatocytes_5"
new.clusters[new.clusters == 24] <- ""
new.clusters[new.clusters == 25] <- ""
new.clusters[new.clusters == 26] <- ""
new.clusters[new.clusters == 27] <- ""
new.clusters[new.clusters == 28] <- "Sp_2"
new.clusters[new.clusters == 29] <- "Spermatocytes_9"
new.clusters[new.clusters == 30] <- "Spermatocytes_3"
new.clusters[new.clusters == 31] <- ""
new.clusters[new.clusters == 32] <- "Sp_4"

```

